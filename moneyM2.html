<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monetary Command v9.1 (QR Float Audit)</title>
    <style>
        :root { 
            --bg: #050505; --card: #121212; --border: #333; 
            --gold: #ffc107; --blue: #2196f3; --green: #00e676; 
            --text: #e0e0e0; --orange: #ff9800; --purple: #9c27b0;
        }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* HEADER */
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid var(--gold); padding-bottom: 15px; }
        .title { font-size: 2rem; color: var(--gold); font-weight: 800; letter-spacing: 4px; text-transform: uppercase; }
        .subtitle { font-size: 0.9rem; color: #888; letter-spacing: 1px; margin-top: 5px; }

        /* AUDIT CARDS */
        .audit-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card); border: 1px solid var(--border); padding: 25px; border-radius: 12px; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.5); transition: 0.3s; }
        .card:hover { transform: translateY(-5px); border-color: #555; }
        
        .card-icon { font-size: 2rem; margin-bottom: 10px; display: block; }
        .card-lbl { font-size: 0.75rem; color: #888; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
        .card-val { font-size: 2.2rem; font-weight: bold; color: #fff; margin: 5px 0; font-family: 'Courier New', monospace; }
        .card-sub { font-size: 0.75rem; color: #666; border-top: 1px dashed #333; padding-top: 10px; margin-top: 10px; font-family: monospace; }

        /* COLORS & STYLES */
        .c-blue { border-top: 4px solid var(--blue); } .t-blue { color: var(--blue); }
        .c-green { border-top: 4px solid var(--green); } .t-green { color: var(--green); }
        .c-purple { border-top: 4px solid var(--purple); } .t-purple { color: var(--purple); }

        /* DISTRIBUTION BAR */
        .dist-box { background: var(--card); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 30px; }
        .bar-container { background: #222; height: 20px; width: 100%; border-radius: 10px; overflow: hidden; display: flex; margin: 15px 0; }
        .bar-seg { height: 100%; transition: width 1s ease-in-out; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; color: #fff; font-weight: bold; text-shadow: 0 1px 2px black; }
        
        .labels { display: flex; justify-content: space-between; font-size: 0.8rem; color: #aaa; }

        .refresh-btn { position: fixed; bottom: 30px; right: 30px; background: var(--gold); color: #000; border: none; width: 60px; height: 60px; border-radius: 50%; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px rgba(255, 193, 7, 0.4); z-index: 100; font-size: 2rem; transition: 0.2s; display:flex; align-items:center; justify-content:center; }
        .refresh-btn:active { transform: scale(0.9); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="title">KOMANDO PUSAT MONETER</div>
        <div class="subtitle">REAL-TIME QR TRACKING ‚Ä¢ SUPPLY AUDIT</div>
    </div>

    <div class="audit-grid">
        <div class="card c-blue">
            <span class="card-icon">üè¶</span>
            <div class="card-lbl">Total Supply (Otoritas)</div>
            <div id="totalMint" class="card-val t-blue">0.00 Dn</div>
            <div class="card-sub">
                Total Uang Sah Dicetak (MINT)<br>
                <span id="mintRaw">0 mg</span>
            </div>
        </div>

        <div class="card c-green">
            <span class="card-icon">üì±</span>
            <div class="card-lbl">Sirkulasi Digital (Sensus)</div>
            <div id="totalOnline" class="card-val t-green">0.00 Dn</div>
            <div class="card-sub">
                Tersimpan di Wallet Warga<br>
                <span id="onlineCount">0 Wallet Aktif</span>
            </div>
        </div>

        <div class="card c-purple">
            <span class="card-icon">üé´</span>
            <div class="card-lbl">QR Token (Fisik/Unclaimed)</div>
            <div id="totalFloat" class="card-val t-purple">0.00 Dn</div>
            <div class="card-sub">
                Dicetak tapi Belum Di-scan<br>
                Status: <span style="color:var(--orange)">BEREDAR DI PASAR</span>
            </div>
        </div>
    </div>

    <div class="dist-box">
        <div class="labels">
            <span>KOMPOSISI PEREDARAN UANG</span>
            <span id="ratioText">Syncing...</span>
        </div>
        <div class="bar-container">
            <div id="barWallet" class="bar-seg" style="width: 0%; background: var(--green);">WALLET (0%)</div>
            <div id="barFloat" class="bar-seg" style="width: 0%; background: var(--purple);">FISIK/QR (0%)</div>
        </div>
        <div style="font-size: 0.75rem; color: #666; text-align: center; margin-top: 10px;">
            "Jika bar UNGU (Fisik) besar, berarti banyak uang yang dicetak tapi belum kembali ke sistem digital (sedang digunakan transaksi offline/barang)."
        </div>
    </div>
</div>

<button onclick="auditSystem()" class="refresh-btn">‚Üª</button>

<script>
    const DB_URL = "https://pasarnuswantara-default-rtdb.asia-southeast1.firebasedatabase.app/";
    const MG_PER_DIRHAM = 2980;
    const MG_PER_DINAR = 80460;

    async function auditSystem() {
        document.body.style.cursor = "wait";
        
        try {
            // 1. FETCH DATA
            let [resLedger, resCensus] = await Promise.all([
                fetch(`${DB_URL}public_ledger.json`).then(r => r.json()),
                fetch(`${DB_URL}census_report.json`).then(r => r.json())
            ]);

            // --- A. HITUNG TOTAL MINTED & QR FLOAT (LOGIKA ARUS) ---
            let totalMintedMg = 0;
            let qrFloatMg = 0; // Ini yang kita cari (4 Dinar itu)

            if(resLedger) {
                for(let key in resLedger) {
                    let tx = resLedger[key];
                    let val = Math.abs(Number(tx.val) || 0);
                    
                    // 1. MINT: Bank cetak uang -> Supply Nambah, Fisik Nambah (karena belum ada di wallet siapa2)
                    if(tx.type === 'MINT' || tx.type === 'ISSUED') {
                        // Validasi Signature Sederhana
                        if(tx.signature && tx.signature.length > 5) {
                            totalMintedMg += val;
                            qrFloatMg += val; 
                        }
                    }

                    // 2. CASH_OUT: Wallet -> Fisik. (Uang keluar dari HP jadi kertas)
                    if(tx.type === 'CASH_OUT') {
                        qrFloatMg += val;
                    }

                    // 3. CLAIM_QR / INBOX: Fisik -> Wallet. (Kertas discan jadi saldo HP)
                    if(tx.type === 'CLAIM_QR' || tx.type === 'INBOX_CLAIM') {
                        qrFloatMg -= val;
                    }

                    // 4. BURN: Musnah selamanya
                    if(tx.type === 'BURN') {
                        totalMintedMg -= val;
                        qrFloatMg -= val;
                    }
                }
            }

            // Koreksi jika minus (seharusnya tidak mungkin kalau data konsisten)
            if (qrFloatMg < 0) qrFloatMg = 0;

            // --- B. HITUNG TOTAL ONLINE (SENSUS REAL) ---
            let totalOnlineMg = 0;
            let walletCount = 0;
            if(resCensus) {
                for(let k in resCensus) {
                    let bal = parseInt(resCensus[k].balance_mg) || 0;
                    totalOnlineMg += bal;
                    walletCount++;
                }
            }

            // --- C. DISPLAY DATA ---
            
            // Konversi ke Dinar (Bisa diganti Dirham kalau mau)
            updateCard('totalMint', totalMintedMg);
            document.getElementById('mintRaw').innerText = totalMintedMg.toLocaleString() + " mg";

            updateCard('totalOnline', totalOnlineMg);
            document.getElementById('onlineCount').innerText = walletCount + " Wallet Terdaftar";

            updateCard('totalFloat', qrFloatMg); // INI YANG AKAN MENAMPILKAN "4 Dn"

            // --- D. UPDATE BAR CHART ---
            // Total Uang Aktif = Online + Float
            let totalActive = totalOnlineMg + qrFloatMg;
            
            let pctOnline = (totalActive > 0) ? (totalOnlineMg / totalActive) * 100 : 0;
            let pctFloat = (totalActive > 0) ? (qrFloatMg / totalActive) * 100 : 0;

            let barWallet = document.getElementById('barWallet');
            let barFloat = document.getElementById('barFloat');

            barWallet.style.width = pctOnline + "%";
            barWallet.innerText = pctOnline > 10 ? `WALLET (${pctOnline.toFixed(1)}%)` : "";
            
            barFloat.style.width = pctFloat + "%";
            barFloat.innerText = pctFloat > 10 ? `FISIK/QR (${pctFloat.toFixed(1)}%)` : "";

            document.getElementById('ratioText').innerText = `Total Sirkulasi: ${(totalActive/MG_PER_DINAR).toFixed(2)} Dn`;

        } catch(e) {
            console.error(e);
            alert("Gagal Audit: " + e.message);
        }
        document.body.style.cursor = "default";
    }

    function updateCard(elemId, mgVal) {
        let valDn = (mgVal / MG_PER_DINAR).toFixed(2);
        document.getElementById(elemId).innerText = valDn + " Dn";
    }

    // Auto Run
    auditSystem();
    setInterval(auditSystem, 10000);
</script>

</body>
</html>
