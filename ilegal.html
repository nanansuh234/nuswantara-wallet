<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Forensik v9.4 (Justice Protocol)</title>
    <style>
        :root { 
            --bg: #050505; --card: #111; --border: #333; 
            --gold: #f1c40f; --blue: #3498db; --green: #2ecc71; 
            --red: #e74c3c; --purple: #9b59b6; --orange: #e67e22;
        }
        body { background-color: var(--bg); color: #e0e0e0; font-family: 'Segoe UI', monospace; margin: 0; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; border: 1px solid var(--border); border-radius: 15px; padding: 20px; box-shadow: 0 0 60px rgba(0,0,0,0.9); background: #0b0b0b; }
        
        .header { text-align: center; border-bottom: 2px solid var(--gold); padding-bottom: 15px; margin-bottom: 25px; }
        .title { font-size: 1.8rem; color: var(--gold); font-weight: bold; letter-spacing: 3px; text-transform: uppercase; }
        .subtitle { font-size: 0.75rem; color: #888; letter-spacing: 1px; margin-top: 5px; }
        
        .dashboard-top { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .main-split { display: grid; grid-template-columns: 1.6fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        /* ZONA BAHAYA (ANIMASI DENYUT) */
        .danger-zone { margin-top: 30px; border: 2px solid var(--red); border-radius: 10px; overflow: hidden; animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 rgba(231, 76, 60, 0); } 50% { box-shadow: 0 0 20px rgba(231, 76, 60, 0.3); } 100% { box-shadow: 0 0 0 rgba(231, 76, 60, 0); } }

        .card { background: #141414; border: 1px solid #222; padding: 15px; text-align: center; border-radius: 10px; position: relative; overflow: hidden; }
        .card::before { content: ''; position: absolute; top:0; left:0; width: 100%; height: 3px; background: #333; }
        
        .c-gold::before { background: var(--gold); }
        .c-red::before { background: var(--red); }
        .c-blue::before { background: var(--blue); }
        .c-green::before { background: var(--green); }

        .lbl { font-size: 0.6rem; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .val { font-size: 1.3rem; font-weight: bold; color: #fff; }
        .sub { font-size: 0.55rem; color: #666; margin-top: 5px; font-style: italic; }

        .meter-box { background: #1a1a1a; height: 6px; width: 100%; border-radius: 3px; margin-top: 8px; overflow: hidden; position: relative; }
        .meter-fill { height: 100%; width: 0%; transition: 1s; }
        
        /* TABLES */
        .box { border: 1px solid #222; background: #000; border-radius: 10px; overflow: hidden; }
        .box-header { background: #1a1a1a; padding: 12px; font-size: 0.75rem; font-weight: bold; color: #aaa; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        
        table { width: 100%; border-collapse: collapse; font-size: 0.7rem; }
        td, th { padding: 10px; text-align: left; border-bottom: 1px solid #111; }
        th { color: #555; font-weight: normal; text-transform: uppercase; }
        .num { text-align: right; font-family: monospace; font-weight: bold; }
        
        .culprit { color: var(--red); font-weight: bold; font-family: monospace; font-size: 0.8rem; }
        
        /* VALUE COLORS */
        .bad-val { color: var(--red); }
        .good-val { color: var(--green); }
        
        /* BUTTON JUSTICE */
        .btn-justice { 
            background: linear-gradient(45deg, #c0392b, #e74c3c); 
            color: white; border: none; padding: 5px 10px; 
            border-radius: 4px; font-size: 0.6rem; cursor: pointer; 
            font-weight: bold; text-transform: uppercase; letter-spacing: 1px; 
            width: 100%; transition: 0.2s;
        }
        .btn-justice:hover { transform: scale(1.05); box-shadow: 0 0 10px var(--red); }
        .btn-disabled { background: #333; color: #555; cursor: not-allowed; border: 1px solid #444; }

        .refresh-btn { position: fixed; bottom: 30px; right: 30px; background: var(--gold); color: #000; border: none; width: 50px; height: 50px; border-radius: 50%; font-weight: bold; cursor: pointer; box-shadow: 0 0 20px rgba(241, 196, 15, 0.4); z-index: 100; font-size: 1.5rem; transition: 0.2s; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="title">NUSWANTARA COMMAND CENTER</div>
        <div class="subtitle">FORENSIC AUDIT SYSTEM v9.4 ‚Ä¢ JUSTICE PROTOCOL</div>
    </div>

    <div class="dashboard-top">
        <div class="card c-gold">
            <div class="lbl">Supply Resmi (Verified)</div>
            <div id="dispSupply" class="val" style="color:var(--gold);">0.00 Dr</div>
            <div class="sub">Total Aset Sah</div>
        </div>
        
        <div class="card c-red">
            <div class="lbl">Uang Palsu Terdeteksi</div>
            <div id="dispFake" class="val" style="color:var(--red);">0.00 Dr</div>
            <div class="sub">Percobaan Pemalsuan</div>
        </div>

        <div class="card c-blue">
            <div class="lbl">Jumlah Transaksi</div>
            <div id="dispTxCount" class="val">0</div>
            <div class="sub">Total Aktivitas</div>
        </div>

        <div class="card c-green">
            <div class="lbl">Status Keamanan</div>
            <div id="sysIntegrity" class="val" style="font-size:1rem;">AMAN</div>
            <div class="sub" id="sysMsg">Database Bersih</div>
        </div>
    </div>

    <div class="main-split">
        <div class="box">
            <div class="box-header">
                <span>‚úÖ TRANSAKSI SAH (TERBARU)</span>
                <span id="statusConn" style="color:var(--green);">Live</span>
            </div>
            <div style="height: 250px; overflow-y: auto;">
                <table id="tableValid">
                    <thead><tr><th>Waktu</th><th>Tipe</th><th>Dari > Ke</th><th class="num">Nilai</th></tr></thead>
                    <tbody id="tbodyValid">
                        <tr><td colspan="4" style="text-align:center; padding:20px; color:#555;">Memuat...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="box">
            <div class="box-header">
                <span>üè¶ POSISI CADANGAN</span>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 25px;">
                    <div style="display:flex; justify-content:space-between; font-size:0.7rem; color:#aaa; margin-bottom:5px;">
                        <span>CADANGAN BANK</span>
                        <span id="txtBank" style="color:var(--gold); font-weight:bold;">0 Dr</span>
                    </div>
                    <div class="meter-box" style="background:#222;"><div id="barBank" class="meter-fill" style="background:var(--gold);"></div></div>
                </div>
                <div style="text-align:center; font-size:0.7rem; color:#666; margin-top:20px;">
                    Sistem otomatis memisahkan supply valid dan invalid berdasarkan Digital Signature otoritas.
                </div>
            </div>
        </div>
    </div>

    <div class="danger-zone">
        <div class="box-header" style="background: var(--red); color: #000;">
            <span>üö® DAFTAR PENERIMA UANG ILEGAL (SUSPECT LIST)</span>
            <span>DATA FORENSIK LIVE</span>
        </div>
        <div style="height: 300px; overflow-y: auto; background: #1a0000;">
            <table id="tableFake">
                <thead>
                    <tr style="border-bottom: 1px solid var(--red);">
                        <th style="color:#ff8888;">TARGET WALLET (TERSANGKA)</th>
                        <th style="color:#ff8888; text-align:right;">SALDO SAAT INI</th>
                        <th style="color:#ff8888; text-align:right;">PERCOBAAN MASUK ILEGAL</th>
                        <th style="color:#ff8888; text-align:right;">HAK ASLI (REFUND)</th>
                        <th style="color:#ff8888;">STATUS FORENSIK</th>
                        <th style="color:#ff8888; text-align:center;">VONIS WARGA</th>
                    </tr>
                </thead>
                <tbody id="tbodyFake">
                    <tr><td colspan="6" style="text-align:center; padding:30px; color:#ff5555; font-style:italic;">
                        Menunggu Data Forensik...
                    </td></tr>
                </tbody>
            </table>
        </div>
        <div style="background:#111; padding:10px; text-align:center; font-size:0.6rem; color:#666; border-top:1px solid #333;">
            *Hak Asli (Refund) = Saldo Saat Ini - Total Uang Ilegal yang diterima. Cek Audit Wallet Untuk Memastikan Peredaran Uang Palsu (Untuk Mencegah Penipuan).
        </div>
    </div>

</div>

<button onclick="refreshData()" class="refresh-btn">‚Üª</button>

<script>
    const DB_URL = "https://pasarnuswantara-default-rtdb.asia-southeast1.firebasedatabase.app/";
    const MG_PER_DIRHAM = 2980;

    // --- FUNGSI EKSEKUSI KEADILAN ---
    async function executeJustice(targetId, fakeReceived, realRight) {
        let msg = `SIDANG RAKYAT UNTUK: ${targetId}\n\n`;
        msg += `‚ö†Ô∏è Ditemukan Uang Palsu Masuk: ${fakeReceived} Dr\n`;
        msg += `‚úÖ Hak Uang Asli (Refund): ${realRight} Dr\n\n`;
        msg += `Apakah Anda yakin ingin MEMBEKUKAN wallet ini?\n`;
        msg += `(Sistem akan mencatat hak refund di database)`;

        if(!confirm(msg)) return;
        
        try {
            await fetch(`${DB_URL}blacklist/${targetId}.json`, {
                method: 'PUT',
                body: JSON.stringify({
                    status: 'BLOCKED',
                    reason: 'UANG_PALSU',
                    fake_amt: fakeReceived,
                    real_refund: realRight,
                    executor: 'PUBLIC_CONSENSUS',
                    timestamp: Date.now()
                })
            });
            alert(`‚öñÔ∏è KEADILAN DITEGAKKAN!\nWallet ${targetId} telah dibekukan.`);
            refreshData();
        } catch(e) {
            alert("Gagal eksekusi: " + e);
        }
    }

    async function refreshData() {
        // Indikator loading kecil
        let tbody = document.getElementById('tbodyFake');
        if(tbody.rows.length === 0) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Syncing...</td></tr>';
        
        document.getElementById('statusConn').innerText = "Syncing...";
        
        try {
            // 1. AMBIL DATA (ANTI-CRASH)
            // Menggunakan catch(() => null) untuk menangani error jika node database belum ada
            let results = await Promise.all([
                fetch(`${DB_URL}public_ledger.json`).then(r => r.json()).catch(() => null),
                fetch(`${DB_URL}census_report.json`).then(r => r.json()).catch(() => null),
                fetch(`${DB_URL}bank_reserve.json`).then(r => r.json()).catch(() => null),
                fetch(`${DB_URL}blacklist.json`).then(r => r.json()).catch(() => null)
            ]);

            // Fallback ke objek kosong jika data null
            let resLedger = results[0] || {};
            let resCensus = results[1] || {};
            let resBank = results[2] || {};
            let resBlacklist = results[3] || {};

            let totalWalletMg = 0;
            let bankTotalMg = 0;
            let fakeSupplyMg = 0;
            let realSupplyMg = 0;
            
            // 2. HITUNG SUPPLY & BANK
            for (let key in resCensus) {
                totalWalletMg += (parseInt(resCensus[key].balance_mg) || 0);
            }
            if (resBank.balance_mg) {
                bankTotalMg = parseInt(resBank.balance_mg) || 0;
                totalWalletMg += bankTotalMg;
            }

            // 3. FORENSIK LEDGER
            let validLog = [];
            let suspects = {}; 
            let txCount = 0;
            let physicalFloatMg = 0;
            
            // Konversi Ledger Object ke Array
            let txs = Object.entries(resLedger).map(([k, v]) => ({...v, id: k}));
            txs.sort((a,b) => (b.timestamp||b.time)-(a.timestamp||a.time));
            txCount = txs.length;

            txs.forEach(tx => {
                let mg = Math.abs(Number(tx.val) || 0);
                let isFake = false;

                // DETEKTOR UANG PALSU (Logic: MINT tanpa Signature Valid)
                if (tx.type === 'MINT') {
                    if (!tx.signature || tx.signature.length < 10) isFake = true;
                }

                if (isFake) {
                    fakeSupplyMg += mg;
                    
                    // KUMPULKAN BUKTI PER TERSANGKA
                    if(tx.to) {
                        if(!suspects[tx.to]) suspects[tx.to] = { fakeIn: 0 };
                        suspects[tx.to].fakeIn += mg;
                    }

                } else {
                    // Logic Valid
                    if (tx.type === 'CASH_OUT') physicalFloatMg += mg;
                    if (tx.type === 'CLAIM_QR' || tx.type === 'INBOX_CLAIM') physicalFloatMg -= mg;
                    
                    validLog.push({
                        time: new Date(tx.timestamp || tx.time).toLocaleTimeString(),
                        type: tx.type,
                        flow: `${(tx.from||'?').substring(0,6)}... > ${(tx.to||'?').substring(0,6)}...`,
                        val: (mg / MG_PER_DIRHAM).toFixed(2)
                    });
                }
            });
            
            if (physicalFloatMg < 0) physicalFloatMg = 0;
            let totalSystemMg = totalWalletMg + physicalFloatMg; 

            // --- UI UPDATE ---
            
            // Stats Atas
            document.getElementById('dispSupply').innerText = (totalSystemMg / MG_PER_DIRHAM).toLocaleString('en-US', {maximumFractionDigits:0}) + " Dr";
            document.getElementById('dispFake').innerText = (fakeSupplyMg / MG_PER_DIRHAM).toLocaleString('en-US', {maximumFractionDigits:2}) + " Dr";
            document.getElementById('dispTxCount').innerText = txCount;
            document.getElementById('txtBank').innerText = (bankTotalMg / MG_PER_DIRHAM).toLocaleString('en-US', {maximumFractionDigits:2}) + " Dr";
            
            let bankPct = (totalSystemMg > 0) ? (bankTotalMg / totalSystemMg) * 100 : 0;
            document.getElementById('barBank').style.width = bankPct + "%";

            // Status Keamanan
            let integrityEl = document.getElementById('sysIntegrity');
            if(fakeSupplyMg > 0) {
                integrityEl.innerText = "BAHAYA";
                integrityEl.style.color = "var(--red)";
                document.getElementById('sysMsg').innerText = "Injeksi Ilegal Terdeteksi!";
            } else {
                integrityEl.innerText = "AMAN";
                integrityEl.style.color = "var(--green)";
                document.getElementById('sysMsg').innerText = "Database Bersih.";
            }

            // Render Table VALID
            let htmlValid = "";
            validLog.slice(0, 20).forEach(row => {
                htmlValid += `<tr>
                    <td style="color:#666;">${row.time}</td>
                    <td><span style="color:var(--blue); font-weight:bold;">${row.type}</span></td>
                    <td style="font-family:monospace; color:#aaa;">${row.flow}</td>
                    <td class="num" style="color:var(--gold);">${row.val}</td>
                </tr>`;
            });
            document.getElementById('tbodyValid').innerHTML = htmlValid || '<tr><td colspan="4" style="text-align:center;">Kosong</td></tr>';

            // Render Table SUSPECTS (ZONA MERAH)
            let htmlFake = "";
            let suspectKeys = Object.keys(suspects);

            if (suspectKeys.length === 0) {
                htmlFake = '<tr><td colspan="6" style="text-align:center; padding:40px; color:var(--green);">‚úÖ TIDAK ADA AKTIVITAS ILEGAL TERDETEKSI.</td></tr>';
            } else {
                suspectKeys.forEach(id => {
                    let fakeInMg = suspects[id].fakeIn;
                    
                    // Ambil Saldo Aktual dari Sensus
                    // PENGAMAN: Cek apakah user ada di census report
                    let currentBalMg = (resCensus[id] && resCensus[id].balance_mg) ? parseInt(resCensus[id].balance_mg) : 0;
                    
                    // Hitung Hak Refund
                    let refundMg = currentBalMg - fakeInMg;
                    
                    // Status Analisis
                    let statusStr = "";
                    let colorStyle = "";
                    
                    if (refundMg < 0) {
                        statusStr = "‚õî FRAUD (Spent Fake)";
                        colorStyle = "color:#ff5555; font-weight:bold;";
                        refundMg = 0; // Gak ada refund
                    } else if (fakeInMg > 0 && currentBalMg > 0) {
                        statusStr = "‚ö†Ô∏è MIXED ASSETS";
                        colorStyle = "color:var(--gold);";
                    } else {
                        statusStr = "üëª GHOST / EMPTY";
                        colorStyle = "color:#777;";
                    }

                    // Cek Apakah Sudah Diblokir
                    let isBlocked = resBlacklist[id] ? true : false;
                    let actionBtn = isBlocked 
                        ? `<button class="btn-justice btn-disabled" disabled>TERKUNCI üîí</button>`
                        : `<button class="btn-justice" onclick="executeJustice('${id}', ${(fakeInMg/MG_PER_DIRHAM).toFixed(2)}, ${(refundMg/MG_PER_DIRHAM).toFixed(2)})">‚öñÔ∏è VONIS (BLOKIR)</button>`;

                    // Konversi Display
                    let curDr = (currentBalMg / MG_PER_DIRHAM).toFixed(2);
                    let fakeDr = (fakeInMg / MG_PER_DIRHAM).toFixed(2);
                    let refDr = (refundMg / MG_PER_DIRHAM).toFixed(2);

                    htmlFake += `<tr>
                        <td class="culprit">${id} ${isBlocked ? '(BLOCKED)' : ''}</td>
                        <td class="num" style="color:#fff;">${curDr} Dr</td>
                        <td class="num" style="color:var(--red);">+${fakeDr} Dr</td>
                        <td class="num" style="color:var(--green);">${refDr} Dr</td>
                        <td style="${colorStyle} font-size:0.65rem;">${statusStr}</td>
                        <td style="text-align:center;">${actionBtn}</td>
                    </tr>`;
                });
            }
            document.getElementById('tbodyFake').innerHTML = htmlFake;

            document.getElementById('statusConn').innerText = "Live";

        } catch (e) {
            console.error(e);
            document.getElementById('statusConn').innerText = "Error";
            // Tampilkan error di tabel agar terlihat
            document.getElementById('tbodyFake').innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">ERROR: ${e.message}</td></tr>`;
        }
    }

    refreshData();
    setInterval(refreshData, 5000);
</script>

</body>

</html>

