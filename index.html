<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuswantara Wallet v27.2 (Secure Ecosystem)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { background-color: #050505; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; font-family: 'Consolas', 'Monaco', monospace; color:white; }
        .btn-action { cursor: pointer; transition: 0.2s; font-family: 'Segoe UI', sans-serif; }
        .btn-action:active { transform: scale(0.95); }
        .file-btn { background: #333; color: #aaa; border: 1px dashed #555; padding: 10px; width: 100%; border-radius: 10px; margin-top: 10px; cursor: pointer; font-size: 0.8rem; display:block; box-sizing:border-box; text-align:center;}
        .btn-scan-key { width:100%; padding:15px; background:#2980b9; color:white; border:none; border-radius:12px; font-weight:bold; font-size: 1rem; margin-bottom:10px; cursor:pointer; }
        
        #paymentModal, #transferModal, #myIdModal, #setupPinModal, #receiptModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:2000; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:20px; box-sizing:border-box; }
        .pay-card { background:#151515; padding:30px; border-radius:20px; border:2px solid #f39c12; width:100%; max-width:400px; position: relative; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        
        /* STRUK STYLE */
        .receipt-card { background: #fff; color: #000; padding: 20px; border-radius: 5px; width: 100%; max-width: 350px; font-family: 'Courier New', monospace; box-shadow: 0 0 20px rgba(255,255,255,0.2); position: relative; }
        .receipt-line { border-bottom: 1px dashed #000; margin: 10px 0; }
        .receipt-row { display: flex; justify-content: space-between; font-size: 0.8rem; margin-bottom: 5px; }
        .receipt-val { font-weight: bold; }

        .id-badge { background: #000; color: #2ecc71; padding: 5px 8px; border-radius: 5px; font-size: 0.65rem; margin-top: 5px; border: 1px solid #333; display: inline-block; font-family: monospace; letter-spacing: 1px; }
        .btn-report { background: #d35400; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.6rem; cursor: pointer; margin-left: 5px; font-weight: bold; }
        .close-btn { position: absolute; top: 10px; right: 15px; color: #e74c3c; background: none; border: none; font-size: 1.2rem; cursor: pointer; font-weight: bold; }
        input:focus { outline: none; border-color: #f39c12; }
        
        /* TOAST NOTIFICATION */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 90%; max-width: 400px; }
        .toast { background: rgba(30, 30, 30, 0.95); color: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid #2ecc71; box-shadow: 0 5px 15px rgba(0,0,0,0.5); display: flex; justify-content: space-between; align-items: center; animation: slideIn 0.3s ease-out; font-family: 'Segoe UI', sans-serif; font-size: 0.8rem; }
        .toast.error { border-left-color: #e74c3c; }
        .toast.info { border-left-color: #3498db; }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .audit-row { display: flex; justify-content: space-between; font-size: 0.65rem; color: #888; border-bottom: 1px solid #222; padding: 5px 0; }
        .audit-val { font-weight: bold; }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="walletApp" style="border: 4px solid #f39c12; background: #000; border-radius: 25px; padding: 25px; width: 100%; max-width: 500px; box-shadow: 0 0 60px rgba(243, 156, 18, 0.15); position:relative;">
    
    <div id="lockScreen" style="display:none; text-align: center; padding: 20px;">
        <div style="font-size: 3.5rem; margin-bottom: 10px;">üõ°Ô∏è</div>
        <h3 id="lockTitle" style="color:#f39c12; margin-bottom: 10px; letter-spacing: 2px;">SECURE LOGIN</h3>
        
        <div id="setupReaderWrapper" style="display:none; margin-bottom: 15px; position:relative;">
            <div id="setupReader" style="width:100%; border-radius:15px; overflow:hidden; border:2px solid #3498db;"></div>
            <button onclick="stopSetupScan()" style="position:absolute; top:10px; right:10px; background:#e74c3c; color:white; border:none; padding:5px 12px; border-radius:8px; z-index:100; cursor:pointer; font-weight:bold;">X</button>
        </div>

        <button onclick="startSetupScan()" class="btn-scan-key">üì∑ SCAN KUNCI PRIVAT</button>
        <label class="file-btn" style="margin-bottom:15px;">
            üìÇ UPLOAD QR KUNCI
            <input type="file" accept="image/*" onchange="scanFromFile(this, 'loginKey')" style="display:none;">
        </label>
        
        <input type="password" id="loginKey" placeholder="Paste Private Key..." style="width:100%; padding:15px; margin-bottom:12px; background:#111; border:1px solid #333; color:#fff; border-radius:12px; text-align:center; font-size: 0.8rem; box-sizing: border-box; font-family:monospace;">
        <input type="password" id="loginPass" placeholder="Password Login" style="width:100%; padding:15px; margin-bottom:20px; background:#111; border:1px solid #333; color:#fff; border-radius:12px; text-align:center; font-size: 1rem; box-sizing: border-box;">
        
        <button onclick="unlockWallet()" class="btn-action" style="width:100%; padding:15px; background:#f39c12; color:#000; border:none; border-radius:12px; font-weight:bold; font-size: 1rem;">BUKA WALLET</button>
        
        <div id="loginMsg" style="color:#e74c3c; font-size:0.7rem; margin-top:10px;"></div>
    </div>

    <div id="walletPanel" style="display:none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
            <div style="text-align:left;">
                <span style="font-size: 0.65rem; color: #f39c12; letter-spacing: 1px; font-weight: bold;">NUSWANTARA v27.2</span><br>
                <div style="display:flex; align-items:center;">
                    <div id="myIDDisplay" class="id-badge">ID: ...</div>
                    <button onclick="forceReport()" class="btn-report">üì° LAPOR</button>
                </div>
            </div>
            <button onclick="logout()" style="background:#222; color:#555; border:none; padding:4px 10px; border-radius:8px; font-size:0.6rem; cursor:pointer;">LOGOUT</button>
        </div>
        
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div id="syncStatus" class="sync-status">Offline Ready</div>
            <button onclick="auditSync()" style="background:none; border:1px solid #333; color:#2980b9; font-size:0.55rem; padding:3px 8px; border-radius:5px; cursor:pointer;">üîÑ AUDIT & SYNC</button>
        </div>

        <div style="background:#111; padding:20px; border-radius:20px; border: 1px solid #222; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-around; text-align: center; margin-bottom: 15px;">
                <div><div id="valDinar" style="font-size: 2.8rem; font-weight: bold; color: #f39c12;">0</div><div style="font-size: 0.7rem; color: #888; font-weight:bold;">DINAR</div></div>
                <div><div id="valDirham" style="font-size: 2.8rem; font-weight: bold; color: #bdc3c7;">0</div><div style="font-size: 0.7rem; color: #888; font-weight:bold;">DIRHAM</div></div>
            </div>
            
            <div style="background:#080808; padding:10px; border-radius:10px; border:1px dashed #333; margin-bottom:10px;">
                <div class="audit-row"><span>Uang Masuk:</span><span id="auditIn" class="audit-val" style="color:#2ecc71">0</span></div>
                <div class="audit-row"><span>Uang Keluar:</span><span id="auditOut" class="audit-val" style="color:#e74c3c">0</span></div>
                <div class="audit-row" style="border:none; padding-top:5px; font-size:0.7rem;"><span>SALDO BERSIH:</span><span id="auditNet" class="audit-val" style="color:#fff">0</span></div>
            </div>

            <div style="border-top: 1px solid #222; padding-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-family: monospace;">
                <div style="text-align: center; background: rgba(243, 156, 18, 0.1); padding: 8px; border-radius: 10px;">
                    <div id="goldGram" style="color: #f39c12; font-size: 0.9rem; font-weight: bold;">0.000g</div><div style="font-size: 0.55rem; color: #666;">EQ. EMAS (Au)</div>
                </div>
                <div style="text-align: center; background: rgba(189, 195, 199, 0.1); padding: 8px; border-radius: 10px;">
                    <div id="silverGram" style="color: #bdc3c7; font-size: 0.9rem; font-weight: bold;">0.000g</div><div style="font-size: 0.55rem; color: #666;">EQ. PERAK (Ag)</div>
                </div>
            </div>
        </div>

        <div id="scanner-wrapper" style="display:none; margin-bottom: 15px; position:relative;">
            <div id="reader" style="width:100%; border-radius:15px; overflow:hidden; border:2px solid #f39c12;"></div>
            <label class="file-btn">üìÇ UPLOAD FOTO QR <input type="file" accept="image/*" onchange="scanFromFile(this, 'tokenIn')" style="display:none;"></label>
            <button onclick="stopScanner()" style="position:absolute; top:10px; right:10px; background:#e74c3c; color:white; border:none; padding:5px 12px; border-radius:8px; z-index:100; cursor:pointer; font-weight:bold;">TUTUP [X]</button>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
            <button onclick="startScanner()" class="btn-action" style="background:#2980b9; color:white; border:none; padding:15px; border-radius:15px; font-weight:bold; font-size:0.8rem;">üì∑ SCAN QR</button>
            <button onclick="toggleClaimManual()" class="btn-action" style="background:#222; color:#2980b9; border:1px solid #2980b9; padding:15px; border-radius:15px; font-weight:bold; font-size:0.8rem;">‚å®Ô∏è MANUAL</button>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
            <button onclick="openTransfer()" class="btn-action" style="background:#8e44ad; color:white; border:none; padding:15px; border-radius:15px; font-weight:bold; font-size:0.8rem;">üí∏ TRANSFER ID</button>
            <button onclick="showMyID()" class="btn-action" style="background:#333; color:white; border:none; padding:15px; border-radius:15px; font-weight:bold; font-size:0.8rem;">üÜî QR SAYA</button>
        </div>

        <div id="manualClaim" style="display:none; margin-bottom:15px; background:#111; padding:15px; border-radius:15px; border: 1px dashed #444;">
            <input type="text" id="tokenIn" placeholder="Paste TOKEN-..." style="width:100%; padding:12px; background:#000; color:white; border:1px solid #333; border-radius:10px; box-sizing:border-box; margin-bottom:10px;">
            <button onclick="execClaim()" class="btn-action" style="width:100%; background:#3498db; color:white; border:none; padding:12px; border-radius:10px; font-weight:bold;">PROSES CLAIM</button>
        </div>

        <div style="background:#111; padding:15px; border-radius:15px; border: 1px solid #222; margin-bottom:15px;">
            <label style="font-size: 0.7rem; color: #f39c12; font-weight:bold; display:block; margin-bottom:8px;">DINAR (EMAS):</label>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom:15px;">
                <button onclick="quickSend(20115, '1/4 Dn')" class="btn-action" style="font-size:0.55rem; padding:10px 0; background:#1a1a1a; color:#ffd700; border:1px solid #444; border-radius:8px;">1/4 Dn</button>
                <button onclick="quickSend(40230, '1/2 Dn')" class="btn-action" style="font-size:0.55rem; padding:10px 0; background:#1a1a1a; color:#ffd700; border:1px solid #444; border-radius:8px;">1/2 Dn</button>
                <button onclick="quickSend(80460, '1 Dn')" class="btn-action" style="font-size:0.55rem; padding:10px 0; background:#222; color:#ffd700; border:1px solid #f39c12; border-radius:8px; font-weight:bold;">1 Dn</button>
                <button onclick="quickSend(160920, '2 Dn')" class="btn-action" style="font-size:0.55rem; padding:10px 0; background:#222; color:#ffd700; border:1px solid #f39c12; border-radius:8px; font-weight:bold;">2 Dn</button>
            </div>
            <label style="font-size: 0.7rem; color: #bdc3c7; font-weight:bold; display:block; margin-bottom:8px;">DIRHAM (PERAK):</label>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">
                <button onclick="quickSend(745, '1/4 Dr')" class="btn-action" style="font-size:0.6rem; padding:10px 0; background:#1a1a1a; color:#fff; border:1px solid #bdc3c7; border-radius:8px;">1/4 Dr</button>
                <button onclick="quickSend(1490, '1/2 Dr')" class="btn-action" style="font-size:0.6rem; padding:10px 0; background:#1a1a1a; color:#fff; border:1px solid #bdc3c7; border-radius:8px;">1/2 Dr</button>
                <button onclick="quickSend(2235, '3/4 Dr')" class="btn-action" style="font-size:0.6rem; padding:10px 0; background:#1a1a1a; color:#fff; border:1px solid #bdc3c7; border-radius:8px;">3/4 Dr</button>
                <button onclick="quickSend(2980, '1 Dr')" class="btn-action" style="font-size:0.6rem; padding:10px 0; background:#333; color:#fff; border:1px solid #bdc3c7; border-radius:8px; font-weight:bold;">1 Dr</button>
                <button onclick="quickSend(5960, '2 Dr')" class="btn-action" style="font-size:0.6rem; padding:10px 0; background:#333; color:#fff; border:1px solid #bdc3c7; border-radius:8px; font-weight:bold;">2 Dr</button>
                <button onclick="quickSend(14900, '5 Dr')" class="btn-action" style="font-size:0.6rem; padding:10px 0; background:#333; color:#fff; border:1px solid #bdc3c7; border-radius:8px; font-weight:bold;">5 Dr</button>
            </div>
        </div>

        <div id="qrResult" style="display:none; background:white; padding:20px; border-radius:20px; margin-top:20px; text-align:center; box-shadow: 0 10px 30px rgba(243,196,15,0.4);">
            <div id="qrcode" style="display: inline-block; margin-bottom: 10px;"></div>
            <div id="textToken" style="font-size:0.5rem; color:#000; word-break:break-all; font-family:monospace; background:#eee; padding:5px; border-radius:5px;" onclick="copy(this)"></div>
            <div style="color:#e74c3c; font-size:0.7rem; margin-top:10px; font-weight:bold; letter-spacing:1px;">SCAN QR UNTUK MENERIMA</div>
        </div>

        <div style="border-top: 1px solid #222; padding-top:15px; margin-top: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 10px;">
                <label style="font-size: 0.6rem; color: #444; text-transform: uppercase;">Riwayat Transaksi (Live ID):</label>
            </div>
            <div id="historyLog" style="height:150px; overflow-y:auto; font-size:0.65rem; background:#000; border-radius:12px; padding:12px;"></div>
        </div>
    </div>
</div>

<div id="setupPinModal" style="display:none;">
    <div class="pay-card">
        <h3 style="color:#f39c12; margin-top:0;">üîê BUAT PIN TRANSAKSI</h3>
        <p style="color:#aaa; font-size:0.8rem;">Untuk keamanan ekstra, buat PIN 6 angka khusus untuk transfer & kirim uang.</p>
        <input type="number" id="newTxPin" placeholder="6 Digit Angka" style="width:100%; padding:15px; background:#222; border:1px solid #555; color:white; border-radius:10px; text-align:center; font-size:1.2rem; letter-spacing:3px; margin-bottom:20px;">
        <button onclick="saveTxPin()" class="btn-action" style="width:100%; padding:15px; background:#2980b9; color:white; border:none; border-radius:10px; font-weight:bold;">SIMPAN PIN</button>
    </div>
</div>

<div id="transferModal">
    <div class="pay-card">
        <button class="close-btn" onclick="document.getElementById('transferModal').style.display='none'">√ó</button>
        <h2 style="color:#8e44ad; margin-top:0;">üí∏ TRANSFER DANA</h2>
        <label style="display:block; text-align:left; color:#888; font-size:0.8rem; margin-bottom:5px;">ID Penerima:</label>
        <input type="text" id="trfDest" placeholder="WARGA-XXXXX" style="width:100%; padding:10px; background:#222; border:1px solid #555; color:white; border-radius:8px; margin-bottom:15px; text-transform:uppercase;">
        <label style="display:block; text-align:left; color:#888; font-size:0.8rem; margin-bottom:5px;">Jumlah (Dirham):</label>
        <input type="number" id="trfAmt" placeholder="0.00" style="width:100%; padding:10px; background:#222; border:1px solid #555; color:white; border-radius:8px; margin-bottom:15px;">
        <label style="display:block; text-align:left; color:#888; font-size:0.8rem; margin-bottom:5px;">PIN Transaksi (6 Angka):</label>
        <input type="password" id="trfPin" placeholder="******" maxlength="6" style="width:100%; padding:10px; background:#222; border:1px solid #555; color:white; border-radius:8px; margin-bottom:20px; text-align:center; letter-spacing: 5px;">
        <button onclick="executeTransfer()" class="btn-action" style="width:100%; padding:15px; background:#8e44ad; color:white; border:none; border-radius:10px; font-weight:bold;">KIRIM SEKARANG</button>
    </div>
</div>

<div id="receiptModal">
    <div class="receipt-card">
        <h3 style="margin:0; text-align:center;">BUKTI TRANSAKSI</h3>
        <p style="text-align:center; font-size:0.7rem; margin-top:5px; margin-bottom:15px;">NUSWANTARA WALLET</p>
        
        <div class="receipt-line"></div>
        
        <div class="receipt-row">
            <span>TANGGAL:</span>
            <span class="receipt-val" id="rcptDate">...</span>
        </div>
        <div class="receipt-row">
            <span>ID TRX:</span>
            <span class="receipt-val" id="rcptId" style="font-size:0.6rem;">...</span>
        </div>
        
        <div class="receipt-line"></div>

        <div class="receipt-row">
            <span>DARI:</span>
            <span class="receipt-val" id="rcptFrom">SAYA</span>
        </div>
        <div class="receipt-row">
            <span>KE:</span>
            <span class="receipt-val" id="rcptTo">...</span>
        </div>
        
        <div class="receipt-line"></div>
        
        <div style="text-align:center; margin:15px 0;">
            <div style="font-size:0.8rem;">TOTAL KIRIM</div>
            <div class="receipt-val" id="rcptAmt" style="font-size:1.5rem;">0.00 Dr</div>
            <div style="font-size:0.7rem; color:#555;">STATUS: BERHASIL</div>
        </div>
        
        <div class="receipt-line"></div>
        
        <button onclick="document.getElementById('receiptModal').style.display='none'" style="width:100%; padding:10px; background:#000; color:white; border:none; font-family:monospace; cursor:pointer;">TUTUP</button>
    </div>
</div>

<div id="myIdModal">
    <div class="pay-card" style="background:white; color:black;">
        <button class="close-btn" onclick="document.getElementById('myIdModal').style.display='none'">√ó</button>
        <h3 style="margin:0 0 10px 0;">QR ID SAYA</h3>
        <div id="qrMyId" style="display:flex; justify-content:center; margin-bottom:10px;"></div>
        <div id="textMyId" style="font-weight:bold; font-family:monospace; background:#eee; padding:5px; border-radius:5px;"></div>
        <p style="font-size:0.8rem; color:#555;">Tunjukkan ini ke pengirim dana.</p>
    </div>
</div>

<script>
const DB_URL = "https://pasarnuswantara-default-rtdb.asia-southeast1.firebasedatabase.app/";
const MG_PER_DIRHAM = 2980;
const MG_PER_DINAR = 80460;

// --- STATE & SECURITY INITIALIZATION (V27.2) ---
let savedKey = localStorage.getItem('nw_key') || "";
let savedPass = localStorage.getItem('nw_pass') || "";
let savedTxPin = localStorage.getItem('nw_tx_pin') || "";
let myID = localStorage.getItem('nw_name');
let totalMg = 0; 
let history = [];

// [SECURITY] AUTO-WIPE IF NO KEY
if (!savedKey) {
    localStorage.removeItem('nw_mg');
    localStorage.removeItem('nw_hist');
    totalMg = 0;
    history = [];
} else {
    totalMg = parseInt(localStorage.getItem('nw_mg') || 0);
    try {
        let rawHist = localStorage.getItem('nw_hist');
        history = rawHist ? JSON.parse(rawHist) : [];
    } catch(e) { history = []; }
}
// -----------------------------------------------

let html5QrCode, setupQrCode;

if (savedKey && !myID) {
    let randomCode = Math.random().toString(36).substring(2, 7).toUpperCase();
    myID = "WARGA-" + randomCode;
    localStorage.setItem('nw_name', myID);
}

if(myID) {
    myID = myID.trim().toUpperCase();
    localStorage.setItem('nw_name', myID);
}

// LOGIKA TAMPILAN LOCKSCREEN
if(savedKey === "") {
    document.getElementById('lockScreen').style.display = "block";
    document.getElementById('lockTitle').innerText = "SETUP WALLET BARU";
    document.getElementById('loginPass').placeholder = "Buat Password (Huruf+Angka+Simbol)";
    document.getElementById('walletPanel').style.display = "none";
} else {
    document.getElementById('lockScreen').style.display = "block";
    document.getElementById('loginKey').style.display = "none"; 
    document.querySelector('.btn-scan-key').style.display = "none";
    document.querySelector('.file-btn').style.display = "none";
    document.getElementById('lockTitle').innerText = "LOGIN WALLET";
    document.getElementById('valDinar').innerText = "0";
    document.getElementById('valDirham').innerText = "0.00";
}

function normalizeID(id) {
    if(!id) return "";
    return id.toString().replace(/[^A-Z0-9]/g, "").toUpperCase();
}

function showToast(msg, type = 'success') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerText = msg;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(-20px)';
        setTimeout(() => container.removeChild(toast), 300);
    }, 3000);
}

function showReceipt(txId, to, amt, date) {
    document.getElementById('rcptDate').innerText = date;
    document.getElementById('rcptId').innerText = txId;
    document.getElementById('rcptTo').innerText = to;
    document.getElementById('rcptAmt').innerText = amt.toFixed(2) + " Dr";
    document.getElementById('receiptModal').style.display = 'flex';
}

async function auditSync(silent = false) {
    if(!myID) return;
    
    // [SECURITY] NO KEY = NO DATA
    if(!savedKey) {
        if(!silent) showToast("Akses Ditolak: Kunci Privat Tidak Ada", "error");
        return;
    }

    let statusEl = document.getElementById('syncStatus');
    if(!silent) statusEl.innerHTML = '<span class="pulse">‚è≥ MENGHITUNG...</span>';

    try {
        let res = await fetch(`${DB_URL}public_ledger.json`);
        let ledger = await res.json();
        
        let income = 0;
        let expense = 0;
        let oldMg = totalMg;
        history = []; 

        if (ledger) {
            for (let key in ledger) {
                let tx = ledger[key];
                let val = Math.abs(Number(tx.val) || 0);
                let sender = normalizeID(tx.from || tx.sender);
                let receiver = normalizeID(tx.to);
                let me = normalizeID(myID); 

                // --- [CRITICAL SECURITY UPDATE v27.2] ---
                // TOLAK SEMUA TRANSAKSI TANPA TANDA TANGAN (SIGNATURE)
                // Ini mencegah mining palsu atau transfer dari wallet "hantu".
                if (!tx.signature || tx.signature.length < 5) continue; 
                // ----------------------------------------

                let isRelated = false;

                if (receiver === me) {
                    income += val;
                    isRelated = true;
                }

                if (sender === me) {
                    expense += val;
                    isRelated = true;
                }

                if(isRelated) {
                    let flow = "";
                    let displayType = tx.type;
                    
                    if (receiver === me && sender !== me) flow = "IN";
                    else if (sender === me && receiver !== me) flow = "OUT";
                    else if (sender === me && receiver === me) flow = "SELF"; 

                    if(flow) {
                        history.push({
                            flow: flow,
                            t: displayType,
                            label: (val/MG_PER_DIRHAM).toFixed(2) + " Dr",
                            val: val,
                            time: new Date(tx.timestamp || tx.time || Date.now()).toLocaleTimeString(),
                            txId: tx.tx_id || key 
                        });
                    }
                }
            }
        }

        totalMg = income - expense;
        if(totalMg < 0) totalMg = 0; 

        if (totalMg > oldMg && !silent) {
            let diff = (totalMg - oldMg) / MG_PER_DIRHAM;
            showToast(`üí∞ DANA MASUK: +${diff.toFixed(2)} Dr`);
        } else if (!silent) {
            showToast("‚úÖ Sync Selesai. Data Update.");
        }

        localStorage.setItem('nw_mg', totalMg);
        localStorage.setItem('nw_hist', JSON.stringify(history));

        document.getElementById('auditIn').innerText = `+${(income/MG_PER_DIRHAM).toFixed(2)} Dr`;
        document.getElementById('auditOut').innerText = `-${(expense/MG_PER_DIRHAM).toFixed(2)} Dr`;
        document.getElementById('auditNet').innerText = `${(totalMg/MG_PER_DIRHAM).toFixed(2)} Dr`;

        updateUI(); 
        if(!silent) {
            statusEl.innerHTML = "‚úÖ LIVE";
            statusEl.style.color = "#2ecc71";
            forceReport();
        }

    } catch(e) {
        console.log("Error:", e);
        if(!silent) {
            statusEl.innerHTML = "‚ö†Ô∏è Gagal Sync";
            statusEl.style.color = "#e74c3c";
            showToast("Gagal Sync: " + e.message, "error");
        }
    }
}

async function checkUserExist(id) {
    let res = await fetch(`${DB_URL}census_report/${id}.json`);
    let data = await res.json();
    if (data) return true;

    let altId = id.includes("-") ? id.replace("-", "") : (id.slice(0, 5) + "-" + id.slice(5));
    let res2 = await fetch(`${DB_URL}census_report/${altId}.json`);
    let data2 = await res2.json();
    if (data2) return true;

    return false;
}

function validatePassword(pass) { return /^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*#?&])[A-Za-z\d@$!%*#?&]{6,}$/.test(pass); }
function unlockWallet() {
    let k = document.getElementById('loginKey').value.trim();
    let p = document.getElementById('loginPass').value.trim();
    let msg = document.getElementById('loginMsg');

    if(savedKey === "") {
        if(k.length < 10) { msg.innerText = "Private Key terlalu pendek!"; return; }
        if(!validatePassword(p)) { msg.innerText = "Password Lemah! Minimal 6 karakter, kombinasi huruf & angka."; return; }
        localStorage.setItem('nw_key', k); localStorage.setItem('nw_pass', p);
        alert("Wallet Dibuat!"); location.reload();
    } else {
        if(p === savedPass) {
            document.getElementById('lockScreen').style.display = "none";
            document.getElementById('walletPanel').style.display = "block";
            if(!savedTxPin) document.getElementById('setupPinModal').style.display = 'flex';
            auditSync(); 
            setInterval(() => auditSync(true), 10000); 
        } else {
            msg.innerText = "PASSWORD SALAH!"; document.getElementById('loginPass').value = "";
        }
    }
}
function saveTxPin() {
    let pin = document.getElementById('newTxPin').value;
    if(pin.length !== 6 || isNaN(pin)) { alert("PIN harus 6 digit angka!"); return; }
    localStorage.setItem('nw_tx_pin', pin); savedTxPin = pin;
    document.getElementById('setupPinModal').style.display = 'none'; showToast("PIN Disimpan!");
}

async function executeTransfer() {
    let dest = document.getElementById('trfDest').value.trim().toUpperCase(); 
    let amtDr = parseFloat(document.getElementById('trfAmt').value);
    let pin = document.getElementById('trfPin').value;
    
    if(!dest || !amtDr || amtDr <= 0) return showToast("Data tidak lengkap", "error");
    if(dest === myID) return showToast("Transfer ke diri sendiri?", "error");
    if(pin !== savedTxPin) return showToast("PIN SALAH!", "error");

    let btn = document.querySelector('#transferModal .btn-action');
    btn.innerText = "‚è≥ CEK ID...";
    btn.disabled = true;

    try {
        let exists = await checkUserExist(dest);
        if(!exists) {
            btn.innerText = "KIRIM SEKARANG";
            btn.disabled = false;
            return showToast(`‚ùå ID Penerima Tidak Ditemukan: ${dest}`, "error");
        }
    } catch(e) { console.log("Skip check"); }

    btn.innerText = "‚è≥ MENGIRIM...";

    let amtMg = Math.round(amtDr * MG_PER_DIRHAM);
    if(amtMg > totalMg) {
        btn.innerText = "KIRIM SEKARANG";
        btn.disabled = false;
        return showToast("SALDO TIDAK CUKUP!", "error");
    }
    
    try {
        const nonce = "TRF-" + Math.random().toString(36).substring(2, 9).toUpperCase();
        // GENERATE SIGNATURE PENGIRIM
        const content = `${amtMg}:${Date.now()}:${nonce}:FROM_${myID}`;
        const signature = createSig(content, savedKey);
        const token = "TOKEN-" + btoa(content + "|" + signature);
        
        await fetch(`${DB_URL}inbox/${dest}.json`, { method: 'POST', body: JSON.stringify(token) });
        
        await fetch(`${DB_URL}public_ledger/${nonce}.json`, { method: 'PUT', body: JSON.stringify({ 
            type: 'P2P', 
            from: myID, 
            to: dest, 
            val: Number(amtMg), 
            timestamp: Date.now(), 
            tx_id: nonce,
            signature: signature // SIGNATURE MASUK LEDGER
        }) });
        
        await auditSync(true);
        showReceipt(nonce, dest, amtDr, new Date().toLocaleString());
        
        document.getElementById('transferModal').style.display = 'none';
    } catch(e) { 
        showToast("Error: " + e, "error"); 
    } finally {
        btn.innerText = "KIRIM SEKARANG";
        btn.disabled = false;
    }
}
async function quickSend(mg, label) {
    if (mg > totalMg) return showToast("SALDO TIDAK CUKUP!", "error");
    if(prompt(`üîê PIN TRANSAKSI (6 Digit):`) !== savedTxPin) return showToast("PIN SALAH!", "error");
    
    const nonce = "W-" + Math.random().toString(36).substring(2, 7).toUpperCase();
    const content = `${mg}:${Date.now()}:${nonce}`;
    const sig = createSig(content, savedKey);
    const token = "TOKEN-" + btoa(content + "|" + sig);
    
    fetch(`${DB_URL}public_ledger/${nonce}.json`, { method: 'PUT', body: JSON.stringify({ type: 'CASH_OUT', from: myID, val: Number(mg), timestamp: Date.now(), tx_id: nonce, signature: sig }) });
    
    setTimeout(() => auditSync(true), 1500); 
    
    document.getElementById('qrResult').style.display = 'block'; document.getElementById('qrcode').innerHTML = ""; new QRCode(document.getElementById("qrcode"), { text: token, width: 200, height: 200 }); document.getElementById('textToken').innerText = token;
    showToast("QR Code Dibuat!");
}

async function execClaim() {
    let input = document.getElementById('tokenIn').value.replace("TOKEN-", "").trim(); if(!input) return;
    
    if(!savedKey) { showToast("Gagal: Butuh Private Key", "error"); return; }

    try {
        let decoded = atob(input), parts = decoded.split("|");
        
        // [SECURITY] CEK STRUKTUR TOKEN: HARUS ADA SIGNATURE
        if(parts.length < 2) throw "Token Tidak Aman (Unsigned)";
        // ---------------------------------------------------

        let data = parts[0].split(":");
        if(data.length < 3) throw "Format Invalid";
        let mg = Number(data[0]), ts = Number(data[1]), nonce = data[2];
        
        if(history.some(h => h.txId === nonce)) { showToast("Token sudah dipakai!", "error"); return; }
        
        let check = await fetch(`${DB_URL}used_tokens/${nonce}.json`);
        let cd = await check.json();
        if(cd && cd.claimed && cd.by === myID) { showToast("‚ôªÔ∏è Token milik sendiri dipulihkan.", "info"); auditSync(); return; }

        const claimSignature = createSig(nonce + myID + "CLAIM", savedKey);

        await fetch(`${DB_URL}used_tokens/${nonce}.json`, { method: 'PUT', body: JSON.stringify({ claimed: true, by: myID, signature: claimSignature, at: new Date().toISOString() }) });
        
        await fetch(`${DB_URL}public_ledger/${nonce}_CLAIM.json`, { method: 'PUT', body: JSON.stringify({ type: 'CLAIM_QR', to: myID, val: Number(mg), timestamp: Date.now(), tx_id: nonce, signature: claimSignature }) });
        
        await auditSync(true); 
        showToast("‚úÖ DANA DITERIMA!"); document.getElementById('manualClaim').style.display = 'none';
    } catch(e) { showToast("GAGAL: " + e, "error"); }
}

function toggleClaimManual() { let m = document.getElementById('manualClaim'); m.style.display = m.style.display === 'none' ? 'block' : 'none'; }
function createSig(d, k) { let s = d + k; let h = 0; for (let i = 0; i < s.length; i++) { h = ((h << 5) - h) + s.charCodeAt(i); h |= 0; } return Math.abs(h).toString(36); }
function copy(el) { navigator.clipboard.writeText(el.innerText); showToast("Disalin ke Clipboard"); }
function logout() { location.reload(); }

async function forceReport() { 
    if(!savedKey) return; 
    try { 
        const reportSig = createSig(myID + totalMg, savedKey);
        await fetch(`${DB_URL}census_report/${myID}.json`, { method: 'PUT', body: JSON.stringify({ name: myID, balance_mg: totalMg, last: Date.now(), signature: reportSig }) }); 
        showToast("üì° Laporan Sensus Terkirim", "info");
    } catch(e){} 
}
function updateUI() { 
    if(isNaN(totalMg)) totalMg = 0;
    document.getElementById('myIDDisplay').innerText = myID; 
    let td = totalMg / MG_PER_DIRHAM; 
    document.getElementById('valDinar').innerText = Math.floor(td / 27); 
    document.getElementById('valDirham').innerText = (td % 27).toFixed(2); 
    document.getElementById('silverGram').innerText = (totalMg / 1000).toFixed(3) + "g"; 
    document.getElementById('goldGram').innerText = (td * (4.25/27)).toFixed(3) + "g"; 
    renderLog(); 
}
function renderLog() {
    history.sort((a, b) => new Date(b.time) - new Date(a.time));
    document.getElementById('historyLog').innerHTML = history.slice(0, 30).map(h => `
        <div style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #222; align-items:center;">
            <div style="width:70%;">
                <span style="color:${h.flow==='IN'?'#2ecc71':'#e74c3c'}; font-weight:bold; font-size:0.75rem;">${h.flow==='IN'?'‚¨áÔ∏è':'‚¨ÜÔ∏è'} ${h.t}</span><br>
                <small style="color:#555;">${h.time}</small>
                <div style="font-size:0.5rem; color:#666; word-break:break-all;">ID: ${h.txId}</div>
            </div>
            <span style="font-size:0.55rem; color:#aaa; font-family:monospace;">${h.label}</span>
        </div>`).join('');
}
function openTransfer() { document.getElementById('transferModal').style.display = 'flex'; }
function showMyID() { document.getElementById('myIdModal').style.display = 'flex'; document.getElementById('textMyId').innerText = myID; document.getElementById('qrMyId').innerHTML = ""; new QRCode(document.getElementById("qrMyId"), { text: "ID:" + myID, width: 200, height: 200 }); }
function startSetupScan() { document.getElementById('setupReaderWrapper').style.display = 'block'; setupQrCode = new Html5Qrcode("setupReader"); setupQrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => { document.getElementById('loginKey').value = txt; stopSetupScan(); }, () => {}); }
function stopSetupScan() { if(setupQrCode) setupQrCode.stop().then(() => { document.getElementById('setupReaderWrapper').style.display = 'none'; }); }
function startScanner() { document.getElementById('scanner-wrapper').style.display = 'block'; html5QrCode = new Html5Qrcode("reader"); html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (txt) => { stopScanner(); if(txt.startsWith("ID:")) { openTransfer(); document.getElementById('trfDest').value = txt.split(":")[1]; } else { document.getElementById('tokenIn').value = txt; execClaim(); } }, () => {}); }
function stopScanner() { if(html5QrCode) html5QrCode.stop().then(() => { document.getElementById('scanner-wrapper').style.display = 'none'; }); }
function scanFromFile(inp, target) { if(!inp.files.length) return; let sId = target==='loginKey'?'setupReader':'reader'; const s = new Html5Qrcode(sId); s.scanFile(inp.files[0], true).then(txt => { document.getElementById(target).value = txt; if(target==='loginKey') stopSetupScan(); else { stopScanner(); execClaim(); } }).catch(e => showToast("Gagal baca QR", "error")); }

window.onload = function() { if(savedKey) { auditSync(); updateUI(); } }
</script>
</body>
</html>
