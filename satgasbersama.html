<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satgas Token Palsu v13.0 (The Truth)</title>
    <style>
        :root { --bg: #050505; --card: #151515; --text: #e0e0e0; --gold: #f1c40f; --green: #2ecc71; --red: #e74c3c; --blue: #3498db; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', monospace; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .header { text-align: center; border-bottom: 2px solid var(--gold); padding-bottom: 20px; margin-bottom: 30px; }
        .title { font-size: 2rem; color: var(--gold); font-weight: bold; letter-spacing: 2px; }
        
        /* DASHBOARD GRID */
        .grid-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card); padding: 20px; border-radius: 15px; border: 1px solid #333; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .val { font-size: 2rem; font-weight: bold; margin: 10px 0; }
        .lbl { font-size: 0.7rem; color: #888; text-transform: uppercase; letter-spacing: 1px; }
        
        /* COLORS & BORDERS */
        .c-gold { border-top: 4px solid var(--gold); color: var(--gold); }
        .c-blue { border-top: 4px solid var(--blue); color: var(--blue); }
        .c-red { border-top: 4px solid var(--red); color: var(--red); }
        .c-green { border-top: 4px solid var(--green); color: var(--green); }

        /* TABLE */
        .audit-box { background: var(--card); border-radius: 15px; border: 1px solid #333; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        th { background: #111; padding: 15px; text-align: left; color: #aaa; border-bottom: 2px solid #333; text-transform: uppercase; }
        td { padding: 12px 15px; border-bottom: 1px solid #222; }
        tr:hover { background: #1a1a1a; }
        
        .num { font-family: 'Courier New', monospace; text-align: right; font-weight: bold; }
        .status-badge { padding: 3px 8px; border-radius: 5px; font-size: 0.65rem; font-weight: bold; }
        
        .refresh-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: var(--gold); color: #000; border: none; font-size: 1.5rem; cursor: pointer; box-shadow: 0 0 20px rgba(241, 196, 15, 0.4); z-index: 100; transition: 0.3s; }
        .refresh-btn:hover { transform: scale(1.1); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="title">NERACA FAKTA v13.0</div>
        <div style="color:#888; font-size:0.9rem;">Audit Forensik: Hanya Menghitung Uang Valid (Ber-Signature)</div>
    </div>

    <div class="grid-stats">
        <div class="card c-gold">
            <div class="lbl">Total Supply Sah (Ledger)</div>
            <div id="dispRealSupply" class="val">0.00 Dr</div>
            <div style="font-size:0.7rem; color:#666;" id="dispRealDn">Equal: 0.00 Dn</div>
        </div>
        <div class="card c-blue">
            <div class="lbl">Sirkulasi Warga (Sensus)</div>
            <div id="dispReported" class="val">0.00 Dr</div>
            <div style="font-size:0.7rem; color:#666;">Data Laporan HP</div>
        </div>
        <div class="card c-red">
            <div class="lbl">Selisih / Uang Hantu</div>
            <div id="dispDiff" class="val">0.00 Dr</div>
            <div style="font-size:0.7rem; color:#666;">Harus di-wipe/sync</div>
        </div>
    </div>

    <div class="audit-box">
        <div style="padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between;">
            <span style="font-weight:bold; color:#fff;">RINCIAN PER WALLET</span>
            <span style="font-size:0.7rem; color:#666;">*Data minus di ledger berarti error perhitungan lama</span>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Wallet ID</th>
                    <th class="num">Laporan (HP)</th>
                    <th class="num">Fakta (Ledger)</th>
                    <th class="num">Selisih</th>
                    <th style="text-align:center;">Status</th>
                </tr>
            </thead>
            <tbody id="auditTable">
                <tr><td colspan="5" style="text-align:center; padding:40px; color:#555;">Sedang menghitung ulang seluruh blockchain...</td></tr>
            </tbody>
        </table>
    </div>
    
    <div style="margin-top:20px; text-align:center; color:#444; font-size:0.7rem;">
        Sistem mengabaikan transaksi MINT tanpa signature dan menghitung BURN sebagai pengurang supply.
    </div>
</div>

<button onclick="auditSystem()" class="refresh-btn">↻</button>

<script>
    const DB_URL = "https://pasarnuswantara-default-rtdb.asia-southeast1.firebasedatabase.app/";
    const MG_PER_DIRHAM = 2980;
    const MG_PER_DINAR = 80460;

    async function auditSystem() {
        let btn = document.querySelector('.refresh-btn');
        btn.style.transform = "rotate(360deg)";
        document.getElementById('auditTable').innerHTML = '<tr><td colspan="5" style="text-align:center; padding:40px;">Syncing & Recalculating...</td></tr>';
        
        try {
            // 1. Fetch All Data
            let [resLedger, resCensus] = await Promise.all([
                fetch(`${DB_URL}public_ledger.json`).then(r => r.json()).catch(() => null),
                fetch(`${DB_URL}census_report.json`).then(r => r.json()).catch(() => null)
            ]);

            let ledger = resLedger || {};
            let census = resCensus || {};

            // 2. REKONSTRUKSI LEDGER DARI NOL (THE TRUTH LOGIC)
            // Kita hitung saldo setiap wallet berdasarkan transaksi yang VALID saja.
            let realBalances = {}; 
            let totalRealSupply = 0;

            // Urutkan transaksi berdasarkan waktu (Penting!)
            let txs = Object.values(ledger).sort((a,b) => (a.timestamp||a.time) - (b.timestamp||b.time));

            txs.forEach(tx => {
                let val = Math.abs(Number(tx.val) || 0);
                
                // === FILTER SUPER KETAT (IRON DOME) ===
                let isFake = false;
                
                // Cek 1: MINTING BODONG (Tanpa Signature)
                if (tx.type === 'MINT') {
                    if (!tx.signature || tx.signature.length < 10) isFake = true;
                }
                
                // Cek 2: BURN (Pembakaran/Buyback)
                if (tx.type === 'BURN') {
                    // Burn mengurangi supply pengirim
                    if (tx.from) {
                        if (!realBalances[tx.from]) realBalances[tx.from] = 0;
                        realBalances[tx.from] -= val;
                    }
                    // Burn tidak menambah supply ke 'to' (System Incinerator)
                    // Jadi tidak perlu 'realBalances[tx.to] += val'
                    return; // Skip logic transfer bawah
                }

                if (!isFake) {
                    // Logic Transfer Biasa / Valid Mint
                    if (tx.to) {
                        if (!realBalances[tx.to]) realBalances[tx.to] = 0;
                        realBalances[tx.to] += val;
                    }
                    if (tx.from) {
                        if (!realBalances[tx.from]) realBalances[tx.from] = 0;
                        realBalances[tx.from] -= val;
                    }
                }
            });

            // 3. COMPARISON (AUDIT)
            let tableHtml = "";
            let totalReported = 0;
            let totalDiff = 0;
            
            // Gabungkan ID dari Sensus & Ledger
            let allIDs = new Set([...Object.keys(census), ...Object.keys(realBalances)]);

            // Hitung Total Supply Real (Sum of positive balances)
            // Kita abaikan System ID saat menjumlah supply beredar
            totalRealSupply = 0;
            for (let id in realBalances) {
                if (id !== 'SYSTEM_MINING' && id !== 'SYSTEM_INCINERATOR' && realBalances[id] > 0) {
                    totalRealSupply += realBalances[id];
                }
            }

            // Loop untuk Tabel
            let rows = [];
            allIDs.forEach(id => {
                // Skip System IDs di Tabel
                if(id === 'SYSTEM_MINING' || id === 'SYSTEM_INCINERATOR') return;

                let repMg = census[id] ? (parseInt(census[id].balance_mg) || 0) : 0;
                let realMg = realBalances[id] || 0;
                if (realMg < 0) realMg = 0; // Koreksi jika hitungan minus

                totalReported += repMg;
                
                let diff = repMg - realMg;
                totalDiff += diff;

                // Tampilkan jika ada saldo atau selisih
                if (repMg > 0 || realMg > 0 || diff !== 0) {
                    let statusBadge = "";
                    if (diff === 0) statusBadge = "<span class='status-badge' style='background:#2ecc71; color:black;'>✅ MATCH</span>";
                    else if (diff > 0) statusBadge = "<span class='status-badge' style='background:#e74c3c; color:white;'>⚠️ INFLATED</span>";
                    else statusBadge = "<span class='status-badge' style='background:#3498db; color:white;'>ℹ️ DEFLATED</span>";

                    rows.push({
                        id: id,
                        rep: repMg,
                        real: realMg,
                        diff: diff,
                        html: `<tr>
                            <td style="font-family:monospace; color:#fff; font-weight:bold;">${id}</td>
                            <td class="num" style="color:var(--blue);">${(repMg/MG_PER_DIRHAM).toFixed(2)}</td>
                            <td class="num" style="color:var(--gold);">${(realMg/MG_PER_DIRHAM).toFixed(2)}</td>
                            <td class="num" style="color:${diff!==0 ? 'var(--red)' : '#555'}">${(diff/MG_PER_DIRHAM).toFixed(2)}</td>
                            <td style="text-align:center;">${statusBadge}</td>
                        </tr>`
                    });
                }
            });

            // Sort: Yang selisihnya paling besar di atas
            rows.sort((a,b) => b.diff - a.diff);
            document.getElementById('auditTable').innerHTML = rows.map(r => r.html).join('');

            // 4. UPDATE CARDS
            document.getElementById('dispRealSupply').innerText = (totalRealSupply/MG_PER_DIRHAM).toLocaleString('en-US', {maximumFractionDigits:2}) + " Dr";
            document.getElementById('dispRealDn').innerText = "Equal: " + (totalRealSupply/MG_PER_DINAR).toLocaleString('en-US', {maximumFractionDigits:2}) + " Dn";
            
            document.getElementById('dispReported').innerText = (totalReported/MG_PER_DIRHAM).toLocaleString('en-US', {maximumFractionDigits:2}) + " Dr";
            
            let diffVal = (totalReported - totalRealSupply) / MG_PER_DIRHAM;
            let diffEl = document.getElementById('dispDiff');
            diffEl.innerText = diffVal.toLocaleString('en-US', {maximumFractionDigits:2}) + " Dr";
            
            if(diffVal > 1) {
                diffEl.style.color = "var(--red)";
                diffEl.innerText = "+" + diffEl.innerText + " (Fake)";
            } else {
                diffEl.style.color = "var(--green)";
            }

        } catch(e) {
            console.error(e);
            alert("Audit Error: " + e);
        }
        btn.style.transform = "none";
    }

    auditSystem();
</script>

</body>
</html>
