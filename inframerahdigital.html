<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VALIDATOR PINTAR v4.3</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { background: #050505; color: #eee; font-family: 'Segoe UI', sans-serif; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; }
        .box { width: 100%; max-width: 480px; border: 1px solid #333; padding: 20px; border-radius: 15px; background: #111; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.6); }
        h2 { text-align: center; margin-top: 0; letter-spacing: 2px; color: #f1c40f; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        button { width: 100%; padding: 12px; font-weight: bold; cursor: pointer; border-radius: 8px; border: none; margin-bottom: 10px; font-size: 0.9rem; transition:0.2s; }
        .btn-key { background: #e67e22; color: white; }
        .btn-scan { background: #3498db; color: white; }
        .btn-check { background: #333; color: #ccc; border: 1px solid #555; }
        input[type="text"] { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: white; border-radius: 8px; text-align: center; margin-bottom: 10px; box-sizing: border-box; }
        .file-upload { display: block; background: #1a1a1a; border: 1px dashed #555; color: #888; padding: 10px; text-align: center; border-radius: 8px; cursor: pointer; margin-bottom: 10px; font-size: 0.8rem; }
        
        #resultBox { display: none; text-align: center; padding: 20px; border-radius: 12px; margin-top: 20px; border: 2px solid; animation: pop 0.3s; }
        @keyframes pop { from{transform:scale(0.9); opacity:0;} to{transform:scale(1); opacity:1;} }
        
        /* WARNA STATUS */
        .circulating { border-color: #2ecc71; background: rgba(46, 204, 113, 0.1); color: #2ecc71; }
        .unregistered { border-color: #3498db; background: rgba(52, 152, 219, 0.1); color: #3498db; }
        .fake { border-color: #e74c3c; background: rgba(231, 76, 60, 0.1); color: #e74c3c; }
        .used { border-color: #f39c12; background: rgba(241, 196, 15, 0.1); color: #f39c12; }

        /* TEXT GAYA */
        .big-val { font-size: 1.8rem; margin: 5px 0; font-weight: bold; }
        .smart-lbl { font-size: 1.1rem; color: #fff; background: rgba(255,255,255,0.1); padding: 5px 10px; border-radius: 5px; margin-bottom: 10px; display: inline-block; }

        #readerKey, #readerToken { width: 100%; border-radius: 10px; overflow: hidden; display: none; margin-bottom: 15px; border: 2px solid #555; }
        
        .legend-box { font-size: 0.75rem; color: #777; border-top: 1px solid #333; padding-top: 15px; margin-top: 10px; }
        .legend-item { display: flex; align-items: start; margin-bottom: 8px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; margin-top: 3px; flex-shrink: 0; }
    </style>
</head>
<body>

    <div class="box">
        <h2>üîç VALIDATOR v4.3</h2>
        
        <div id="setupArea">
            <p style="text-align:center; color:#aaa; font-size:0.8rem;">SETUP: Masukkan Kunci Otoritas</p>
            <div id="readerKey"></div>
            <button onclick="startScan('KEY')" class="btn-key">üì∑ SCAN KUNCI</button>
            <label class="file-upload">üìÇ UPLOAD QR KUNCI <input type="file" accept="image/*" onchange="scanFromFile(this, 'KEY')" style="display:none;"></label>
        </div>

        <div id="checkArea" style="display:none;">
            <div style="background:#2ecc71; color:black; padding:5px; text-align:center; border-radius:5px; font-weight:bold; font-size:0.7rem; margin-bottom:15px;">‚úÖ ALAT AKTIF</div>
            <div id="readerToken"></div>
            <button onclick="startScan('TOKEN')" class="btn-scan">üì∑ SCAN UANG</button>
            <label class="file-upload">üìÇ UPLOAD QR UANG <input type="file" accept="image/*" onchange="scanFromFile(this, 'TOKEN')" style="display:none;"></label>
            <p style="text-align:center; color:#555; font-size:0.8rem; margin:10px 0;">--- MANUAL ---</p>
            <input type="text" id="tokenInput" placeholder="Paste Kode Token...">
            <button onclick="validateToken()" class="btn-check">VERIFIKASI</button>
        </div>
    </div>

    <div id="resultBox"></div>

    <div class="box" style="margin-top:0;">
        <h3 style="font-size:0.9rem; color:#888; text-transform:uppercase; margin-top:0;">üìã SOP STATUS</h3>
        <div class="legend-box">
            <div class="legend-item">
                <div class="dot" style="background:#2ecc71;"></div>
                <div><strong style="color:#2ecc71;">HIJAU (SIRKULASI)</strong><br>Asli & Terdaftar Cloud. <b>Terima.</b></div>
            </div>
            <div class="legend-item">
                <div class="dot" style="background:#3498db;"></div>
                <div><strong style="color:#3498db;">BIRU (OFFLINE/BARU)</strong><br>Asli tapi belum lapor Cloud. <b>Cek Fisik lalu Terima.</b></div>
            </div>
            <div class="legend-item">
                <div class="dot" style="background:#e74c3c;"></div>
                <div><strong style="color:#e74c3c;">MERAH (PALSU)</strong><br>Tanda tangan salah. <b>Tolak & Sita.</b></div>
            </div>
        </div>
    </div>

<script>
    const DB_URL = "https://pasarnuswantara-default-rtdb.asia-southeast1.firebasedatabase.app/";
    let html5QrCode;
    let ACTIVE_KEY = "";

    // --- FUNGSI SMART LABEL (PENERJEMAH ANGKA) ---
    function getSmartLabel(mg) {
        mg = parseInt(mg);
        // Emas (Dinar)
        if(mg === 160920) return "2 Dinar (Au)";
        if(mg === 80460) return "1 Dinar (Au)";
        if(mg === 40230) return "1/2 Dinar (Au)";
        if(mg === 20115) return "1/4 Dinar (Au)";
        
        // Perak (Dirham)
        if(mg === 14900) return "5 Dirham (Ag)";
        if(mg === 5960) return "2 Dirham (Ag)";
        if(mg === 2980) return "1 Dirham (Ag)";
        if(mg === 2235) return "3/4 Dirham (Ag)";
        if(mg === 1490) return "1/2 Dirham (Ag)";
        if(mg === 745) return "1/4 Dirham (Ag)";
        
        // Kustom / Ganjil
        if(mg >= 80460) return (mg/80460).toFixed(3) + " Dinar";
        return (mg/2980).toFixed(2) + " Dirham";
    }

    function scanFromFile(inputEl, mode) {
        if (inputEl.files.length === 0) return;
        let readerId = (mode === 'KEY') ? "readerKey" : "readerToken";
        const tempScanner = new Html5Qrcode(readerId);
        tempScanner.scanFile(inputEl.files[0], true)
            .then(decodedText => {
                if(mode === 'KEY') handleKeySuccess(decodedText);
                else { document.getElementById('tokenInput').value = decodedText; validateToken(); }
            })
            .catch(err => { alert("Gagal membaca QR!"); });
    }

    function startScan(mode) {
        let readerId = (mode === 'KEY') ? "readerKey" : "readerToken";
        if(html5QrCode) stopScan();
        document.getElementById(readerId).style.display = 'block';
        html5QrCode = new Html5Qrcode(readerId);
        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, 
        (decodedText) => {
            stopScan();
            if(mode === 'KEY') handleKeySuccess(decodedText);
            else { document.getElementById('tokenInput').value = decodedText; validateToken(); }
        }, () => {});
    }

    function stopScan() {
        if(html5QrCode) {
            html5QrCode.stop().then(() => {
                document.querySelectorAll('[id^="reader"]').forEach(el => el.style.display = 'none');
            }).catch(err=>{});
        }
    }

    function handleKeySuccess(key) {
        if(key.length < 5) return alert("Kunci tidak valid!");
        ACTIVE_KEY = key;
        document.getElementById('setupArea').style.display = 'none';
        document.getElementById('checkArea').style.display = 'block';
        alert("Kunci Diterima!");
    }

    async function validateToken() {
        if(!ACTIVE_KEY) return alert("Masukkan Kunci Otoritas dulu!");
        let raw = document.getElementById('tokenInput').value.trim();
        let resBox = document.getElementById('resultBox');
        
        if(!raw) return;

        resBox.style.display = 'block';
        resBox.className = "box";
        resBox.innerHTML = "‚è≥ MENERJEMAHKAN TOKEN...";
        resBox.style.borderColor = "#555"; resBox.style.color = "#aaa";

        try {
            // 1. CEK MATEMATIKA
            let cleanToken = raw.replace("TOKEN-", "");
            let decoded = atob(cleanToken);
            let [payload, sig] = decoded.split("|");
            
            let calcSig = createSig(payload, ACTIVE_KEY);
            if (calcSig !== sig) {
                return showResult("FAKE", "‚õî PALSU", "Signature Salah. Uang Tidak Valid.");
            }

            // 2. CEK DATABASE
            let [val, time, nonce] = payload.split(":");
            let nominalDn = (val / 80460).toFixed(4);
            let smartLabel = getSmartLabel(val); // <--- INI FITUR BARUNYA

            let [regReq, usedReq] = await Promise.all([
                fetch(`${DB_URL}issued_tokens/${nonce}.json`),
                fetch(`${DB_URL}used_tokens/${nonce}.json`)
            ]);
            let regData = await regReq.json();
            let usedData = await usedReq.json();

            // A. SUDAH DIPAKAI?
            if (usedData) {
                return showResult("USED", "‚ö†Ô∏è SUDAH DIPAKAI", 
                    `<div class="big-val">${nominalDn} Dn</div>
                     <div class="smart-lbl">${smartLabel}</div><br>
                     <small>Dicairkan: ${new Date(usedData.at).toLocaleString()}</small>`);
            }

            // B. ADA DI CLOUD?
            if (regData) {
                showResult("CIRCULATING", "‚úÖ VALID (SIRKULASI)", 
                    `<div class="big-val">${nominalDn} Dn</div>
                     <div class="smart-lbl">${smartLabel}</div><br>
                     <small>Issuer: ${regData.issuer || "Wallet Warga"}</small>`);
            } else {
                showResult("UNREGISTERED", "‚ÑπÔ∏è VALID (OFFLINE/BARU)", 
                    `<div class="big-val">${nominalDn} Dn</div>
                     <div class="smart-lbl">${smartLabel}</div><br>
                     <small>Signature: ASLI (Valid)</small><br>
                     <small style="color:#f1c40f;">Belum masuk database Cloud. "Wajib kroscek settlement fisik" </small>`);
            }

        } catch (e) {
            showResult("FAKE", "‚õî ERROR", "Format token rusak.");
        }
    }

    function showResult(type, title, htmlContent) {
        let b = document.getElementById('resultBox');
        b.className = "box " + type.toLowerCase();
        b.innerHTML = `<h2 style="margin-top:0; border:none;">${title}</h2>${htmlContent}`;
    }

    function createSig(d, k) {
        let s = d + k; let h = 0;
        for (let i = 0; i < s.length; i++) { h = ((h << 5) - h) + s.charCodeAt(i); h |= 0; }
        return Math.abs(h).toString(36);
    }
</script>

</body>
</html>
