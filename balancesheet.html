<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIVE PUBLIC LEDGER - NUSWANTARA OS</title>
    <style>
        body { 
            background-color: #050505; 
            color: #ccc; 
            font-family: 'Segoe UI', 'Courier New', monospace; 
            margin: 0; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh;
        }

        .container { 
            width: 100%; 
            max-width: 1000px; 
            border: 1px solid #222; 
            background: #090909; 
            border-radius: 15px; 
            overflow: hidden; 
            box-shadow: 0 0 80px rgba(212, 175, 55, 0.1);
        }

        /* HEADER */
        .header {
            background: #111;
            padding: 20px 30px;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 1.2rem; color: #d4af37; letter-spacing: 3px; text-transform: uppercase; font-weight: 800; }
        .sub-head { font-size: 0.75rem; color: #666; letter-spacing: 1px; }

        /* JAM NUSWANTARA CUSTOM */
        .clock-box { text-align: right; }
        .clock-time {
            font-size: 1.8rem;
            color: #d4af37; 
            font-weight: bold;
            font-family: monospace;
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
            letter-spacing: 2px;
        }
        .period-badge {
            font-size: 0.8rem;
            background: #222;
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #444;
            vertical-align: middle;
            margin-left: 5px;
        }
        .clock-date {
            font-size: 0.7rem;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
            margin-top: 5px;
        }
        .clock-fase {
            font-size: 0.6rem;
            color: #3498db;
            letter-spacing: 1px;
            font-style: italic;
        }

        /* DASHBOARD SUMMARY */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border-bottom: 2px solid #333;
        }
        .stat-card {
            padding: 20px;
            text-align: center;
            border-right: 1px solid #222;
            background: #0e0e0e;
        }
        .stat-card:last-child { border-right: none; }
        
        .stat-val { font-size: 2.5rem; font-weight: bold; margin: 5px 0; }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; color: #666; }
        
        .gold-txt { color: #d4af37; text-shadow: 0 0 20px rgba(241, 196, 15, 0.2); }
        .silver-txt { color: #bdc3c7; text-shadow: 0 0 20px rgba(189, 195, 199, 0.2); }

        /* LIST AREA */
        #ledgerList { height: 60vh; overflow-y: auto; }

        .tx-row {
            display: grid;
            grid-template-columns: 1.5fr 1.5fr 1.5fr 1fr; 
            padding: 15px 30px;
            border-bottom: 1px solid #1a1a1a;
            align-items: center;
            transition: 0.2s;
            font-size: 0.9rem;
        }
        .tx-row:hover { background: #151515; }
        
        .col-head { background: #0e0e0e; color: #555; font-size: 0.7rem; font-weight: bold; border-bottom: 1px solid #222; }

        /* BADGES & VALUES */
        .badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.65rem; text-transform: uppercase; width: fit-content; display: inline-block; }
        .type-mint { background: rgba(46, 204, 113, 0.15); color: #2ecc71; border: 1px solid #2ecc71; }
        .type-burn { background: rgba(231, 76, 60, 0.15); color: #e74c3c; border: 1px solid #e74c3c; }
        .type-transfer { background: rgba(52, 152, 219, 0.15); color: #3498db; border: 1px solid #3498db; }

        .val-plus { color: #2ecc71; font-weight: bold; }
        .val-min { color: #e74c3c; font-weight: bold; }
        .val-neutral { color: #3498db; font-weight: bold; }
        
        .tx-id { color: #444; font-size: 0.7rem; cursor: pointer; text-decoration: none; text-align: right; font-family: monospace; }
        .tx-id:hover { color: #888; text-decoration: underline; }
        .time-box { display: flex; flex-direction: column; }
        .time-main { color: #d4af37; font-weight: bold; font-size: 0.85rem; }
        .time-sub { color: #666; font-size: 0.7rem; font-style: italic; }
        .sender-info { display: block; font-size: 0.65rem; color: #666; margin-top: 4px; font-style: italic; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #090909; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>PUBLIC LEDGER</h1>
            <div class="sub-head">MONITOR KEUANGAN NUSWANTARA</div>
        </div>
        <div class="clock-box">
            <div class="clock-time">
                <span id="nusantaraTime">00:00</span>
                <span id="nusantaraPeriod" class="period-badge">...</span>
            </div>
            <div class="clock-date" id="nusantaraDate">...</div>
            <div class="clock-fase" id="nusantaraFase">...</div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Sirkulasi Emas</div>
            <div class="stat-val gold-txt" id="sumDinar">0.00 <span style="font-size:1rem;">Dn</span></div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Sirkulasi Perak</div>
            <div class="stat-val silver-txt" id="sumDirham">0.00 <span style="font-size:1rem;">Dr</span></div>
        </div>
    </div>

    <div class="tx-row col-head">
        <div>WAKTU (NUSA)</div>
        <div>JENIS TRANSAKSI</div>
        <div>NOMINAL</div>
        <div style="text-align:right;">ID TRANSAKSI</div>
    </div>

    <div id="ledgerList">
        <div style="padding:50px; text-align:center; color:#333;">Memuat data blockchain...</div>
    </div>
</div>

<script>
    const DB_URL = "https://pasarnuswantara-default-rtdb.asia-southeast1.firebasedatabase.app/";
    const MG_PER_DINAR = 80460;
    const MG_PER_DIRHAM = 2980;

    // --- KAMUS NUSWANTARA OS ---
    const MONTHS_NUSA = ["Wiwitan", "Gangga", "Bija", "Trubus", "Teja", "Baskara", "Kartika", "Huma", "Phala", "Lumbung", "Reswara", "Purnaka", "Suwung"];
    const PASARAN = ["Legi", "Pahing", "Pon", "Wage", "Kliwon"];
    const DAYS_NUSA = ["Radite", "Soma", "Anggara", "Buda", "Respati", "Sukra", "Tumpek"]; // Minggu - Sabtu
    
    const PHASE_DB = [
        { id: 7, name: "ISTIWA" }, { id: 8, name: "ASAR" },
        { id: 1, name: "SANDIKALA" }, { id: 2, name: "SIREPAN" },
        { id: 3, name: "HENING" }, { id: 4, name: "FAJAR" },
        { id: 5, name: "DUHA" }, { id: 6, name: "KARYA" }
    ];

    // --- LOGIKA KONVERSI WAKTU ---
    function convertToNusantaraTime(dateObj) {
        const h = dateObj.getHours();
        const m = dateObj.getMinutes();
        const s = dateObj.getSeconds();

        let mTotalMin = ((h % 12) * 60) + m + (s/60);
        let nTotalHours = mTotalMin / 90; 
        
        let dHour = Math.floor(nTotalHours) || 8;
        let dMin = Math.floor((nTotalHours % 1) * 90);
        
        let period = (h >= 6 && h < 18) ? "SIANG" : "MALAM";

        const phaseSequence = [3, 4, 5, 6, 7, 8, 1, 2];
        let seqIdx = Math.floor(h / 3);
        let currentPhase = PHASE_DB.find(p => p.id === phaseSequence[seqIdx]);

        return {
            timeStr: `${String(dHour).padStart(2, '0')}:${String(dMin).padStart(2, '0')}`,
            period: period,
            fase: currentPhase.name
        };
    }

    // --- LOGIKA KONVERSI KALENDER ---
    function convertToNusantaraDate(dateObj) {
        let yr = dateObj.getFullYear();
        let anchor = new Date(yr, 2, 21);
        if (dateObj < anchor) { anchor = new Date(yr - 1, 2, 21); yr--; }

        let diff = Math.floor((dateObj - anchor) / 86400000);
        let nMonthIdx = Math.floor(diff / 28);
        let nDay = (diff % 28) + 1;
        let nYear = yr - 2024; 
        
        let totalDays = Math.floor((dateObj - new Date(2025, 2, 21)) / 86400000);
        let pIdx = (2 + (totalDays % 5)) % 5; 
        if (pIdx < 0) pIdx += 5;

        // Ambil Nama Hari (0=Minggu -> Radite)
        let dayIdx = dateObj.getDay();

        return {
            day: nDay,
            month: MONTHS_NUSA[nMonthIdx] || "Suwung",
            year: String(nYear).padStart(3, '0'),
            pasaran: PASARAN[pIdx],
            dayName: DAYS_NUSA[dayIdx] // Nama Hari Baru
        };
    }

    // --- UPDATE JAM BERJALAN ---
    function updateClock() {
        const now = new Date();
        const nTime = convertToNusantaraTime(now);
        const nDate = convertToNusantaraDate(now);
        
        document.getElementById('nusantaraTime').innerText = nTime.timeStr;
        document.getElementById('nusantaraPeriod').innerText = nTime.period;
        
        // UPDATE FORMAT TANGGAL DI POJOK ATAS
        document.getElementById('nusantaraDate').innerText = `${nDate.dayName}, ${nDate.day} ${nDate.month} ${nDate.year} | ${nDate.pasaran}`;
        document.getElementById('nusantaraFase').innerText = `FASE: ${nTime.fase}`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    // --- FETCH DATA ---
    async function fetchAllData() {
        let bust = "?r=" + Date.now();
        try {
            let resStats = await fetch(`${DB_URL}market_stats.json${bust}`);
            let stats = await resStats.json();
            let totalMg = (stats && stats.total_supply_mg) ? parseInt(stats.total_supply_mg) : 0;
            
            let dinar = (totalMg / MG_PER_DINAR).toFixed(2);
            let dirham = (totalMg / MG_PER_DIRHAM).toFixed(2);
            
            document.getElementById('sumDinar').innerHTML = `${dinar} <span style="font-size:1rem;">Dn</span>`;
            document.getElementById('sumDirham').innerHTML = `${dirham} <span style="font-size:1rem;">Dr</span>`;

            let resLedger = await fetch(`${DB_URL}public_ledger.json?orderBy="$key"&limitToLast=50`);
            let data = await resLedger.json();
            
            if(!data) {
                document.getElementById('ledgerList').innerHTML = '<div style="padding:50px; text-align:center; color:#333;">Belum ada catatan transaksi publik.</div>';
                return;
            }

            let logs = Object.values(data).sort((a,b) => b.timestamp - a.timestamp);
            
            let html = logs.map(log => {
                let dateObj = new Date(log.timestamp);
                
                let nTime = convertToNusantaraTime(dateObj);
                let nDate = convertToNusantaraDate(dateObj);
                
                // Di list transaksi, kita pakai format ringkas
                let displayDate = `${nDate.dayName}, ${nDate.day} ${nDate.month} ${nDate.year}`;
                let displayTime = `${nTime.timeStr} ${nTime.period}`;
                
                let isMint = log.type === 'MINT';
                let isBurn = log.type === 'BURN';
                let typeBadge, valClass, valStr, senderHtml = "";

                if (isMint) {
                    typeBadge = `<span class="badge type-mint">CETAK</span>`; valClass = 'val-plus'; valStr = `+ ${log.label}`;
                    senderHtml = `<span class="sender-info">Oleh: BANK SENTRAL</span>`;
                } else if (isBurn) {
                    typeBadge = `<span class="badge type-burn">LEBUR</span>`; valClass = 'val-min'; 
                    valStr = log.label; if(!valStr.includes("-")) valStr = "- " + valStr;
                    senderHtml = `<span class="sender-info">Ke: BANK SENTRAL</span>`;
                } else {
                    typeBadge = `<span class="badge type-transfer">KIRIM</span>`; valClass = 'val-neutral'; valStr = `> ${log.label}`;
                    let sender = log.sender || "ANONIM"; senderHtml = `<span class="sender-info">Dari: ${sender}</span>`;
                }

                return `
                    <div class="tx-row">
                        <div class="time-box">
                            <span class="time-main">${displayDate}</span>
                            <span class="time-sub">${displayTime}</span>
                        </div>
                        <div>${typeBadge}${senderHtml}</div>
                        <div class="${valClass}">${valStr}</div>
                        <div class="tx-id" onclick="copy('${log.tx_id}')" title="Salin ID">#${log.tx_id.substring(0, 8)}...</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('ledgerList').innerHTML = html;

        } catch(e) { console.error("Error fetching data:", e); }
    }

    function copy(text) { navigator.clipboard.writeText(text); alert("ID Disalin: " + text); }

    setInterval(fetchAllData, 3000);
    fetchAllData(); 
</script>

</body>
</html>
