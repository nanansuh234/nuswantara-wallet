<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuswantara Economic Monitor v5.5 (Date Fix)</title>
    <style>
        :root { --neon: #d4af37; --bg: #050505; --card: #111; --border: #333; }
        body { background-color: var(--bg); color: #e0e0e0; font-family: 'Segoe UI', monospace; margin: 0; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; border: 1px solid var(--border); border-radius: 15px; padding: 20px; box-shadow: 0 0 60px rgba(0,0,0,0.8); background: #0b0b0b; }
        
        /* HEADER WAKTU */
        .time-header { text-align: center; border-bottom: 2px solid var(--neon); padding-bottom: 15px; margin-bottom: 20px; background: rgba(20,20,20,0.6); border-radius: 10px; padding-top: 15px; border: 1px solid #222; }
        .nusa-year { font-size: 0.8rem; color: #777; letter-spacing: 4px; text-transform: uppercase; margin-bottom: 5px; }
        .nusa-date { font-size: 1.8rem; color: var(--neon); font-weight: bold; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; text-shadow: 0 0 15px rgba(212, 175, 55, 0.4); }
        .nusa-time-block { display: flex; justify-content: center; align-items: baseline; gap: 10px; margin-top: 5px; }
        .nusa-phase { font-size: 1.5rem; color: #fff; font-weight: bold; letter-spacing: 2px; }
        .nusa-digital { font-size: 1.2rem; color: #f39c12; font-family: 'Courier New', monospace; background: #000; padding: 2px 8px; border-radius: 4px; border: 1px solid #444; }
        .nusa-desc { font-size: 0.75rem; color: #aaa; font-style: italic; margin-top: 5px; }

        /* LIVE STATUS */
        .sub-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 5px; }
        h1 { color: #f39c12; margin: 0; font-size: 1.1rem; letter-spacing: 2px; text-transform: uppercase; }
        .live-status { display: inline-flex; align-items: center; background: rgba(46, 204, 113, 0.1); border: 1px solid rgba(46, 204, 113, 0.3); padding: 5px 12px; border-radius: 20px; }
        .blink-dot { width: 6px; height: 6px; background-color: #2ecc71; border-radius: 50%; display: inline-block; margin-right: 8px; box-shadow: 0 0 8px #2ecc71; animation: pulse 1.5s infinite; }
        .status-text { font-size: 0.65rem; color: #2ecc71; font-weight: bold; letter-spacing: 1px; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* SECTION TITLE */
        .sec-title { font-size: 0.7rem; color: #555; text-transform: uppercase; letter-spacing: 2px; margin: 20px 0 10px 0; border-bottom: 1px dashed #333; padding-bottom: 5px; }

        /* DASHBOARD GRID */
        .dashboard { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 10px; }
        .card { background: #141414; border: 1px solid #222; padding: 15px; text-align: center; border-radius: 10px; }
        .card-title { color: #888; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .card-val { font-size: 1.6rem; font-weight: bold; color: #fff; }
        .gold { color: #f1c40f; text-shadow: 0 0 10px rgba(241, 196, 15, 0.2); }
        .silver { color: #bdc3c7; text-shadow: 0 0 10px rgba(189, 195, 199, 0.2); }
        
        .blue { color: #3498db; text-shadow: 0 0 10px rgba(52, 152, 219, 0.2); }
        .card-note { font-size: 0.55rem; color: #444; margin-top: 5px; font-style: italic; }

        /* DAILY STATS */
        .daily-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 25px; }
        .mini-card { background: #141414; border: 1px solid #222; padding: 10px; text-align: center; border-radius: 8px; }
        .mini-label { font-size: 0.55rem; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }
        .mini-val { font-size: 1rem; font-weight: bold; margin-top: 2px; font-family: monospace; }
        .limit-over { color: #e74c3c; animation: pulse 0.5s infinite; } .limit-warn { color: #f1c40f; } .limit-ok { color: #2ecc71; }

        /* TABEL LOG */
        .ledger-box { border: 1px solid #222; height: 450px; overflow-y: auto; background: #000; padding: 0; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        th { text-align: left; background: #1a1a1a; padding: 12px 15px; color: #888; text-transform: uppercase; font-size: 0.6rem; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid #333; letter-spacing: 1px; }
        td { border-bottom: 1px solid #111; padding: 10px 15px; vertical-align: top; }
        tr:hover { background: #0e0e0e; }

        /* BADGES & FLOW */
        .badge { padding: 3px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: bold; border: 1px solid transparent; display: inline-block; text-transform: uppercase; width: 70px; text-align: center; margin-bottom: 4px; }
        .bg-mint { background: rgba(46, 204, 113, 0.1); color: #2ecc71; border-color: #2ecc71; }
        .bg-trf { background: rgba(52, 152, 219, 0.1); color: #3498db; border-color: #3498db; }
        .bg-burn { background: rgba(231, 76, 60, 0.1); color: #e74c3c; border-color: #e74c3c; }
        .bg-phys { background: rgba(243, 156, 18, 0.1); color: #f39c12; border-color: #f39c12; }
        
        .tx-val { font-weight: bold; font-size: 0.85rem; font-family: monospace; }
        .tx-ref { font-family: monospace; font-size: 0.55rem; color: #555; display: block; letter-spacing: 0.5px; }
        
        .flow-container { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; }
        .id-badge { background: #222; color: #ddd; padding: 2px 6px; border-radius: 4px; border: 1px solid #444; font-family: monospace; font-size: 0.7rem; }
        .sys-badge { background: rgba(243, 156, 18, 0.15); color: #f39c12; padding: 2px 6px; border-radius: 4px; border: 1px solid #f39c12; font-weight: bold; font-size: 0.65rem; letter-spacing: 1px; }
        .arrow { color: #666; font-size: 0.8rem; }

        .refresh-btn { background: #1a1a1a; color: var(--neon); border: 1px solid #333; padding: 12px; width: 100%; border-radius: 8px; cursor: pointer; margin-top: 20px; transition: 0.3s; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; }
        .refresh-btn:hover { background: #222; border-color: var(--neon); }
    </style>
</head>
<body>

<div class="container">
    
    <div class="time-header">
        <div id="nusaYear" class="nusa-year">TAHUN ...</div>
        <div id="nusaFullDate" class="nusa-date">...</div>
        <div class="nusa-time-block">
            <div id="nusaPhase" class="nusa-phase">...</div>
            <div id="nusaClock" class="nusa-digital">00:00</div>
        </div>
        <div id="nusaDesc" class="nusa-desc">...</div>
    </div>

    <div class="sub-header">
        <h1>MONITOR EKONOMI NUSWANTARA</h1>
        <div class="live-status">
            <span class="blink-dot"></span>
            <span class="status-text">AUDIT MODE</span>
        </div>
    </div>
    
    <div class="sec-title">TOTAL ASET SISTEM (AUDIT SENSUS)</div>
    <div class="dashboard">
        <div class="card">
            <div class="card-title">Stok Emas (Dinar)</div>
            <div id="circDinar" class="card-val gold">0.00 Dn</div>
            <div class="card-note">Saldo Warga + Bank + Token Fisik</div>
        </div>
        <div class="card">
            <div class="card-title">Stok Perak (Dirham)</div>
            <div id="circDirham" class="card-val silver">0.00 Dr</div>
            <div class="card-note">Saldo Warga + Bank + Token Fisik</div>
        </div>
    </div>

    <div class="sec-title">AKTIVITAS EKONOMI</div>
    <div class="dashboard">
        <div class="card" style="border-color: #3498db;">
            <div class="card-title" style="color:#3498db;">Total Volume Transaksi</div>
            <div id="velocityVal" class="card-val blue">0.00 Dr</div>
            <div class="card-note">Akumulasi Pergerakan Uang</div>
        </div>
        <div class="card" style="border-color: #2ecc71;">
            <div class="card-title" style="color:#2ecc71;">Populasi Terdaftar</div>
            <div id="populationVal" class="card-val" style="color:#2ecc71;">0</div>
            <div class="card-note">Wallet Aktif + Bank</div>
        </div>
    </div>

    <div class="daily-stats">
        <div class="mini-card">
            <div class="mini-label">QUOTA HARIAN</div>
            <div id="dailyTotalDisplay" class="mini-val limit-ok">0 / 1000</div>
        </div>
        <div class="mini-card" style="border-bottom: 2px solid #3498db;">
            <div class="mini-label" style="color:#3498db;">TRANSFER</div>
            <div id="dailyTrfCount" class="mini-val" style="color:#fff;">0</div>
        </div>
        <div class="mini-card" style="border-bottom: 2px solid #2ecc71;">
            <div class="mini-label" style="color:#2ecc71;">CETAK / FISIK</div>
            <div id="dailyMintCount" class="mini-val" style="color:#fff;">0</div>
        </div>
    </div>

    <div class="ledger-box">
        <table id="ledgerTable">
            <thead>
                <tr>
                    <th width="30%">Waktu (Nusa)</th>
                    <th width="15%">Ref ID</th>
                    <th width="35%">Arus Dana</th>
                    <th width="20%" style="text-align:right;">Nominal</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="4" style="text-align:center; padding:50px; color:#555;">
                    ðŸ“¡ Mengambil Data Audit...
                </td></tr>
            </tbody>
        </table>
    </div>

    <button onclick="loadData()" class="refresh-btn">Segarkan Data</button>
</div>

<script>
    const DB_URL = "https://pasarnuswantara-default-rtdb.asia-southeast1.firebasedatabase.app/";
    const MG_PER_DIRHAM = 2980;
    const MG_PER_DINAR = 80460;
    
    // --- KONFIGURASI TANGGAL ---
    // Offset +3 biar sinkron: (22 + 3 = 25 Lumbung)
    const DATE_OFFSET = 3; 
    const DAY_START_HOUR = 3;
    const DAILY_LIMIT = 1000;

    const NUSA_MONTH_MAP = ["Wiwitan", "Gangga", "Bija", "Trubus", "Teja", "Baskara", "Kartika", "Huma", "Phala", "Reswara", "Purnaka", "LUMBUNG"]; 
    const PASARANS = ["Legi", "Pahing", "Pon", "Wage", "Kliwon"];
    const YEAR_CONFIG = {
        "2025": { code: "001", label: "TAHUN 001 - AIR (VENUS)" },
        "2026": { code: "002", label: "TAHUN 002 - BATU (SATURNUS)" }
    };
    const PHASE_DB = [
        { id: 7, name: "ISTIWA", desc: "Hening/Istiwa", range: [12, 14] },
        { id: 8, name: "ASAR", desc: "Wrapping Up", range: [15, 17] },
        { id: 1, name: "SANDIKALA", desc: "Transisi & Sosial", range: [18, 20] },
        { id: 2, name: "SIREPAN", desc: "Istirahat Fisik", range: [21, 23] },
        { id: 3, name: "HENING", desc: "Istirahat Mental", range: [0, 2] },
        { id: 4, name: "FAJAR", desc: "The Golden Hour", range: [3, 5] },
        { id: 5, name: "DUHA", desc: "Start Engine", range: [6, 8] },
        { id: 6, name: "KARYA", desc: "High Performance", range: [9, 11] }
    ];

    // --- TIME FUNCTIONS ---
    function convertToNusaClock(h, m) {
        let mTotal = ((h % 12) * 60) + m;
        let nHour = Math.floor(mTotal / 90); 
        let nMin = Math.floor((mTotal / 90 % 1) * 90); 
        if (nHour === 0) nHour = 8; 
        return `${String(nHour).padStart(2,'0')}:${String(nMin).padStart(2,'0')}`;
    }

    function getNusaCalendar(timestamp) {
        let rawDate = new Date(timestamp);
        let adjustedDate = new Date(rawDate.getTime());
        adjustedDate.setHours(rawDate.getHours() - DAY_START_HOUR); // Day Shift
        adjustedDate.setDate(adjustedDate.getDate() + DATE_OFFSET); // Offset

        let year = adjustedDate.getFullYear();
        let monthIdx = adjustedDate.getMonth();
        let dateNum = adjustedDate.getDate(); 

        let config = YEAR_CONFIG[year] || { code: "XXX", label: `TAHUN M-${year}` };
        let monthName = NUSA_MONTH_MAP[monthIdx] || "SUWUNG";

        let anchor2025 = new Date(2025, 2, 21);
        let diffTotal = Math.floor((adjustedDate - anchor2025) / 86400000);
        let pIdx = (2 + (diffTotal % 5)) % 5; 
        if(pIdx < 0) pIdx += 5;

        return {
            yearCode: config.code,
            yearLabel: config.label,
            date: dateNum, 
            month: monthName.toUpperCase(),
            pasaran: PASARANS[pIdx].toUpperCase(),
            fullString: `${dateNum} ${monthName.toUpperCase()} ${config.code}`
        };
    }

    function getNusaTime(timestamp) {
        let d = new Date(timestamp);
        let h = d.getHours();
        let m = d.getMinutes();
        let seqIdx = Math.floor(h / 3); 
        const phaseMap = [3, 4, 5, 6, 7, 8, 1, 2];
        let pId = phaseMap[seqIdx];
        let p = PHASE_DB.find(x => x.id === pId);
        let period = (h >= 6 && h < 18) ? "SIANG" : "MALAM";
        let digitalNusa = convertToNusaClock(h, m);
        return { name: p.name, desc: p.desc, clock: digitalNusa, period: period };
    }

    function updateHeader() {
        const now = Date.now();
        const cal = getNusaCalendar(now);
        const time = getNusaTime(now);
        document.getElementById('nusaYear').innerText = cal.yearLabel;
        document.getElementById('nusaFullDate').innerText = cal.fullString;
        document.getElementById('nusaPhase').innerText = time.name;
        document.getElementById('nusaClock').innerText = `${time.clock} ${time.period}`;
        document.getElementById('nusaDesc').innerText = time.desc;
    }
    setInterval(updateHeader, 1000);
    updateHeader();

    function formatFlowID(id) {
        if(!id || id.includes("SYS") || id.includes("BANK")) return `<span class="sys-badge">${id}</span>`;
        return `<span class="id-badge">${id.replace("WARGA-", "")}</span>`;
    }

    async function loadData() {
        const tbody = document.getElementById('tableBody');
        try {
            // 1. FETCH PARALEL (Ledger + Census)
            let [resLedger, resCensus, resBank] = await Promise.all([
                fetch(`${DB_URL}public_ledger.json`).then(r => r.json()),
                fetch(`${DB_URL}census_report.json`).then(r => r.json()),
                fetch(`${DB_URL}bank_reserve.json`).then(r => r.json().catch(() => null))
            ]);

            // 2. HITUNG TOTAL SUPPLY DARI SENSUS (REAL ASSETS)
            let totalSystemMg = 0;
            let population = 0;

            // A. Saldo Wallet Warga
            if (resCensus) {
                for (let k in resCensus) {
                    let bal = parseInt(resCensus[k].balance_mg) || 0;
                    totalSystemMg += bal;
                    population++;
                }
            }
            // B. Saldo Bank (Jika ada)
            if (resBank) {
                let bankBal = parseInt(resBank.balance_mg) || 0;
                totalSystemMg += bankBal;
            }

            // 3. HITUNG TOKEN FISIK YANG BELUM DI-CLAIM (FLOAT)
            let velocityMg = 0;
            let physicalFloatMg = 0;
            let txs = [];
            
            if(resLedger) {
                for(let k in resLedger) {
                    let tx = resLedger[k];
                    tx.txId = k;
                    txs.push(tx);
                    
                    let mg = Math.abs(Number(tx.val) || 0);
                    
                    // Velocity (Volume Transaksi)
                    velocityMg += mg;

                    // Hitung Uang Fisik yg "Melayang"
                    if (tx.type === 'CASH_OUT') physicalFloatMg += mg;
                    if (tx.type === 'CLAIM_QR' || tx.type === 'INBOX_CLAIM') physicalFloatMg -= mg;
                }
            }
            if (physicalFloatMg < 0) physicalFloatMg = 0;

            // TOTAL SUPPLY = SENSUS + FISIK YG BELUM DICLAIM
            let finalSupplyMg = totalSystemMg + physicalFloatMg;

            // --- 4. RENDER DATA ---
            
            // Supply Cards
            document.getElementById('circDinar').innerText = (finalSupplyMg / MG_PER_DINAR).toLocaleString('en-US', {maximumFractionDigits: 2}) + " Dn";
            document.getElementById('circDirham').innerText = (finalSupplyMg / MG_PER_DIRHAM).toLocaleString('en-US', {maximumFractionDigits: 2}) + " Dr";

            // Velocity & Pop
            document.getElementById('velocityVal').innerText = (velocityMg / MG_PER_DIRHAM).toLocaleString('en-US', {maximumFractionDigits: 2}) + " Dr";
            document.getElementById('populationVal').innerText = population;

            // Daily Stats Setup
            let now = new Date();
            let todayStart = new Date(now);
            if(now.getHours() < DAY_START_HOUR) { todayStart.setDate(todayStart.getDate() - 1); }
            todayStart.setHours(DAY_START_HOUR, 0, 0, 0);
            let startLimitTime = todayStart.getTime();
            let dCount=0, dTrf=0, dMint=0;

            // Render Table
            txs.sort((a,b) => (b.timestamp||b.time)-(a.timestamp||a.time));
            let html = "";

            txs.forEach(tx => {
                let mg = Math.abs(Number(tx.val) || 0);
                let t = tx.timestamp || tx.time || 0;
                let rawId = tx.tx_id || tx.txId || "UNK";
                let shortId = rawId.substring(0,8)+"...";

                // Tentukan Badge & Label
                let badgeClass="bg-trf", badgeLabel="TRANSFER";
                let rawFrom = tx.from || tx.issuer || "SYSTEM";
                let rawTo = tx.to || "SYSTEM";

                if (tx.type === 'MINT' || tx.type === 'ISSUED') {
                    badgeClass="bg-mint"; badgeLabel="CETAK BARU"; rawFrom="SYSTEM";
                } else if (tx.type === 'BURN') {
                    badgeClass="bg-burn"; badgeLabel="HANGUS"; rawTo="SYSTEM";
                } else if (tx.type === 'CASH_OUT') {
                    badgeClass="bg-phys"; badgeLabel="KE FISIK"; 
                } else if (tx.type === 'CLAIM_QR' || tx.type === 'INBOX_CLAIM') {
                    badgeClass="bg-phys"; badgeLabel="DARI FISIK";
                } else {
                    badgeClass="bg-trf"; badgeLabel="TRANSFER";
                }

                // Daily Count
                if(t >= startLimitTime) {
                    dCount++;
                    if(tx.type === 'MINT'||tx.type==='ISSUED'||tx.type==='CASH_OUT') dMint++;
                    else dTrf++;
                }

                let cal = getNusaCalendar(t);
                let tim = getNusaTime(t);
                let detailTime = `<span style="color:#b8860b; font-weight:bold; font-size:0.9rem;">${cal.date} ${cal.month}</span> <br> <span style="color:#fff; font-weight:bold;">${tim.name}</span> <span style="color:#777; font-family:monospace;">${tim.clock}</span>`;
                let flowHtml = `<div class="flow-container">${formatFlowID(rawFrom)} <span class="arrow">âž”</span> ${formatFlowID(rawTo)}</div>`;
                let valStr = (mg >= 80460) ? (mg/80460).toFixed(2)+" Dn" : (mg/2980).toFixed(2)+" Dr";
                let colorVal = (mg >= 80460) ? "#f1c40f" : "#bdc3c7";

                html += `<tr><td>${detailTime}</td><td style="vertical-align:middle;"><span class="badge ${badgeClass}">${badgeLabel}</span><span class="tx-ref">#${shortId}</span></td><td>${flowHtml}</td><td style="text-align:right;"><span class="tx-val" style="color:${colorVal}">${valStr}</span></td></tr>`;
            });

            if(txs.length === 0) html = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#555;">Data Ledger Kosong</td></tr>';
            tbody.innerHTML = html;

            // Update Daily Counters
            let dlEl = document.getElementById('dailyTotalDisplay');
            dlEl.innerText = `${dCount} / ${DAILY_LIMIT}`;
            dlEl.className = "mini-val " + (dCount >= DAILY_LIMIT ? "limit-over" : (dCount >= DAILY_LIMIT*0.8 ? "limit-warn" : "limit-ok"));
            document.getElementById('dailyTrfCount').innerText = dTrf;
            document.getElementById('dailyMintCount').innerText = dMint;

        } catch(e) { tbody.innerHTML = `<tr><td colspan="4" style="color:#e74c3c; text-align:center;">Error: ${e}</td></tr>`; }
    }

    loadData();
    setInterval(loadData, 5000); 
</script>

</body>
</html>
