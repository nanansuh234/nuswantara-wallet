<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIVE PUBLIC LEDGER - NUSWANTARA STANDARD</title>
    <style>
        body { 
            background-color: #050505; 
            color: #ccc; 
            font-family: 'Segoe UI', 'Courier New', monospace; 
            margin: 0; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh;
        }

        .container { 
            width: 100%; 
            max-width: 1000px; 
            border: 1px solid #222; 
            background: #090909; 
            border-radius: 15px; 
            overflow: hidden; 
            box-shadow: 0 0 80px rgba(212, 175, 55, 0.1);
        }

        /* HEADER */
        .header {
            background: #111;
            padding: 20px 30px;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .brand h1 { margin: 0; font-size: 1.2rem; color: #d4af37; letter-spacing: 3px; text-transform: uppercase; font-weight: 800; }
        .sub-head { font-size: 0.75rem; color: #666; letter-spacing: 1px; }

        /* JAM NUSWANTARA DISPLAY */
        .clock-box { text-align: right; }
        
        .clock-main {
            font-size: 2rem;
            color: #d4af37; 
            font-weight: bold;
            font-family: monospace;
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
            letter-spacing: 2px;
            line-height: 1;
        }
        
        .period-badge {
            font-size: 0.7rem;
            background: #222;
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #444;
            vertical-align: text-top;
            margin-left: 5px;
        }

        .clock-date {
            font-size: 0.8rem;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .clock-fase {
            font-size: 0.65rem;
            color: #3498db;
            letter-spacing: 1px;
            font-style: italic;
            margin-top: 2px;
        }

        /* STATS */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border-bottom: 2px solid #333;
        }
        .stat-card {
            padding: 20px;
            text-align: center;
            border-right: 1px solid #222;
            background: #0e0e0e;
        }
        .stat-card:last-child { border-right: none; }
        
        .stat-val { font-size: 2.5rem; font-weight: bold; margin: 5px 0; }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; color: #666; }
        
        .gold-txt { color: #d4af37; text-shadow: 0 0 20px rgba(241, 196, 15, 0.2); }
        .silver-txt { color: #bdc3c7; text-shadow: 0 0 20px rgba(189, 195, 199, 0.2); }

        /* LIST */
        #ledgerList { height: 60vh; overflow-y: auto; }

        .tx-row {
            display: grid;
            grid-template-columns: 1.6fr 1.4fr 1.5fr 1fr; 
            padding: 15px 30px;
            border-bottom: 1px solid #1a1a1a;
            align-items: center;
            transition: 0.2s;
            font-size: 0.9rem;
        }
        .tx-row:hover { background: #151515; }
        
        .col-head { background: #0e0e0e; color: #555; font-size: 0.7rem; font-weight: bold; border-bottom: 1px solid #222; }

        /* BADGES */
        .badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.65rem; text-transform: uppercase; display: inline-block; }
        .type-mint { background: rgba(46, 204, 113, 0.15); color: #2ecc71; border: 1px solid #2ecc71; }
        .type-burn { background: rgba(231, 76, 60, 0.15); color: #e74c3c; border: 1px solid #e74c3c; }
        .type-transfer { background: rgba(52, 152, 219, 0.15); color: #3498db; border: 1px solid #3498db; }

        .val-plus { color: #2ecc71; font-weight: bold; }
        .val-min { color: #e74c3c; font-weight: bold; }
        .val-neutral { color: #3498db; font-weight: bold; }
        
        .tx-id { color: #444; font-size: 0.7rem; cursor: pointer; font-family: monospace; text-align: right; }
        .tx-id:hover { color: #888; text-decoration: underline; }
        
        .time-box { display: flex; flex-direction: column; }
        .time-main { color: #d4af37; font-weight: bold; font-size: 0.8rem; }
        .time-sub { color: #666; font-size: 0.7rem; font-style: italic; }
        .sender-info { display: block; font-size: 0.65rem; color: #666; margin-top: 4px; font-style: italic; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #090909; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="brand">
            <h1>PUBLIC LEDGER</h1>
            <div class="sub-head">MONITOR KEUANGAN NUSWANTARA</div>
        </div>
        <div class="clock-box">
            <div class="clock-main">
                <span id="nTime">00:00</span>
                <span id="nPeriod" class="period-badge">...</span>
            </div>
            <div class="clock-date" id="nDateFull">...</div>
            <div class="clock-fase" id="nFase">...</div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Sirkulasi Setara Emas</div>
            <div class="stat-val gold-txt" id="sumDinar">0.00 <span style="font-size:1rem;">Dn</span></div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Sirkulasi Setara Perak</div>
            <div class="stat-val silver-txt" id="sumDirham">0.00 <span style="font-size:1rem;">Dr</span></div>
        </div>
    </div>

    <div class="tx-row col-head">
        <div>WAKTU (NUSA)</div>
        <div>JENIS TRANSAKSI</div>
        <div>NOMINAL</div>
        <div style="text-align:right;">ID TRANSAKSI</div>
    </div>

    <div id="ledgerList">
        <div style="padding:50px; text-align:center; color:#333;">Memuat data blockchain...</div>
    </div>
</div>

<script>
    /* =======================================================
       NUSWANTARA STANDARD LIBRARY (CORE)
       Epoch: 21 Maret 2025 (Jumat Pahing) = 01 Wiwitan 001
       ======================================================= */
    
    const DB_URL = "https://pasarnuswantara-default-rtdb.asia-southeast1.firebasedatabase.app/";
    const MG_PER_DINAR = 80460;
    const MG_PER_DIRHAM = 2980;

    const NUSA = {
        EPOCH: new Date(2025, 2, 21), // 21 Maret 2025
        EPOCH_DAY_IDX: 5, // Jumat (0=Radite/Minggu)
        EPOCH_PASARAN_IDX: 1, // Pahing (0=Legi)
        MONTHS: ["Wiwitan", "Gangga", "Bija", "Trubus", "Teja", "Baskara", "Kartika", "Huma", "Phala", "Lumbung", "Reswara", "Purnaka", "Suwung"],
        DAYS: ["Radite", "Soma", "Anggara", "Buda", "Respati", "Sukra", "Tumpek"],
        PASARANS: ["Legi", "Pahing", "Pon", "Wage", "Kliwon"],
        PHASES: [
            { id: 7, name: "ISTIWA (8-2 Siang)" }, { id: 8, name: "ASAR (2-4 Siang)" },
            { id: 1, name: "SANDIKALA (4-6 Malam)" }, { id: 2, name: "SIREPAN (6-8 Malam)" },
            { id: 3, name: "HENING (8-2 Malam)" }, { id: 4, name: "FAJAR (2-4 Malam)" },
            { id: 5, name: "DUHA (4-6 Siang)" }, { id: 6, name: "KARYA (6-8 Siang)" }
        ]
    };

    // 1. FUNGSI WAKTU (JAM 1-8)
    function getNusaTime(dateObj) {
        const h = dateObj.getHours();
        const m = dateObj.getMinutes();
        const s = dateObj.getSeconds();

        let mTotalMin = ((h % 12) * 60) + m + (s/60);
        let nTotalHours = mTotalMin / 90; 
        
        let dHour = Math.floor(nTotalHours) || 8;
        let dMin = Math.floor((nTotalHours % 1) * 90);
        
        let period = (h >= 6 && h < 18) ? "SIANG" : "MALAM";
        let seqIdx = Math.floor(h / 3);
        let currentPhase = NUSA.PHASES.find(p => p.id === [3, 4, 5, 6, 7, 8, 1, 2][seqIdx]);

        return {
            str: `${String(dHour).padStart(2, '0')}:${String(dMin).padStart(2, '0')}`,
            period: period,
            fase: currentPhase ? currentPhase.name : ""
        };
    }

    // 2. FUNGSI KALENDER (EPOCH BASED)
    function getNusaDate(dateObj) {
        // A. Hitung Selisih Hari Total dari Epoch
        // Kita pakai UTC di internal agar tidak kena Daylight Saving/Zona Waktu aneh
        let uNow = Date.UTC(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
        let uEpoch = Date.UTC(2025, 2, 21);
        let diffDays = Math.floor((uNow - uEpoch) / (1000 * 60 * 60 * 24));

        // B. Hitung Hari & Pasaran (Pasti Akurat)
        // Pakai rumus (Awal + Diff) % Siklus. Tambah kelipatan besar agar support tanggal mundur.
        let dayIdx = (NUSA.EPOCH_DAY_IDX + diffDays) % 7;
        if (dayIdx < 0) dayIdx += 7;
        
        let pasaranIdx = (NUSA.EPOCH_PASARAN_IDX + diffDays) % 5;
        if (pasaranIdx < 0) pasaranIdx += 5;

        // C. Hitung Tahun & Bulan (Solar Anchor 21 Maret)
        let yr = dateObj.getFullYear();
        let anchor = new Date(yr, 2, 21);
        if (dateObj < anchor) {
            anchor = new Date(yr - 1, 2, 21);
            yr--; 
        }
        
        // Hitung hari sejak 21 Maret tahun tersebut
        let uAnchor = Date.UTC(anchor.getFullYear(), anchor.getMonth(), anchor.getDate());
        let daysSinceAnchor = Math.floor((uNow - uAnchor) / (1000 * 60 * 60 * 24));
        
        let nMonthIdx = 0;
        let nDate = 0;

        if (daysSinceAnchor < 336) { // 12 Sasih x 28
            nMonthIdx = Math.floor(daysSinceAnchor / 28);
            nDate = (daysSinceAnchor % 28) + 1;
        } else { // Sasih ke-13 (Suwung)
            nMonthIdx = 12;
            nDate = (daysSinceAnchor - 336) + 1;
        }

        let nYear = yr - 2024; // 2025 = Tahun 1

        return {
            dayName: NUSA.DAYS[dayIdx],
            pasaran: NUSA.PASARANS[pasaranIdx],
            date: nDate,
            month: NUSA.MONTHS[nMonthIdx],
            year: String(nYear).padStart(3, '0'),
            full: `${NUSA.DAYS[dayIdx]}, ${nDate} ${NUSA.MONTHS[nMonthIdx]} ${String(nYear).padStart(3, '0')} | ${NUSA.PASARANS[pasaranIdx]}`
        };
    }

    // --- MAIN APP ---

    function updateClock() {
        const now = new Date();
        const t = getNusaTime(now);
        const d = getNusaDate(now);
        
        document.getElementById('nTime').innerText = t.str;
        document.getElementById('nPeriod').innerText = t.period;
        document.getElementById('nDateFull').innerText = d.full;
        document.getElementById('nFase').innerText = t.fase;
    }
    setInterval(updateClock, 1000); updateClock();

    async function fetchAllData() {
        let bust = "?r=" + Date.now();
        try {
            // Stats
            let resStats = await fetch(`${DB_URL}market_stats.json${bust}`);
            let stats = await resStats.json();
            let totalMg = (stats && stats.total_supply_mg) ? parseInt(stats.total_supply_mg) : 0;
            document.getElementById('sumDinar').innerHTML = `${(totalMg/MG_PER_DINAR).toFixed(2)} <span style="font-size:1rem;">Dn</span>`;
            document.getElementById('sumDirham').innerHTML = `${(totalMg/MG_PER_DIRHAM).toFixed(2)} <span style="font-size:1rem;">Dr</span>`;

            // Ledger
            let resLedger = await fetch(`${DB_URL}public_ledger.json?orderBy="$key"&limitToLast=50`);
            let data = await resLedger.json();
            if(!data) { document.getElementById('ledgerList').innerHTML = '<div style="padding:50px; text-align:center;">Data kosong.</div>'; return; }

            let logs = Object.values(data).sort((a,b) => b.timestamp - a.timestamp);
            let html = logs.map(log => {
                let dateObj = new Date(log.timestamp);
                let t = getNusaTime(dateObj);
                let d = getNusaDate(dateObj);
                
                // Format Ringkas di List
                let dispDate = `${d.dayName}, ${d.date} ${d.month} ${d.year} (${d.pasaran})`;
                let dispTime = `${t.str} ${t.period}`;

                let isMint = log.type === 'MINT';
                let isBurn = log.type === 'BURN';
                let typeBadge, valClass, valStr, senderHtml = "";

                if (isMint) {
                    typeBadge = `<span class="badge type-mint">CETAK</span>`; valClass = 'val-plus'; valStr = `+ ${log.label}`;
                    senderHtml = `<span class="sender-info">Oleh: BANK SENTRAL</span>`;
                } else if (isBurn) {
                    typeBadge = `<span class="badge type-burn">LEBUR</span>`; valClass = 'val-min'; 
                    valStr = log.label; if(!valStr.includes("-")) valStr = "- " + valStr;
                    senderHtml = `<span class="sender-info">Ke: BANK SENTRAL</span>`;
                } else {
                    typeBadge = `<span class="badge type-transfer">KIRIM</span>`; valClass = 'val-neutral'; valStr = `> ${log.label}`;
                    let sender = log.sender || "ANONIM"; senderHtml = `<span class="sender-info">Dari: ${sender}</span>`;
                }

                return `
                    <div class="tx-row">
                        <div class="time-box"><span class="time-main">${dispDate}</span><span class="time-sub">${dispTime}</span></div>
                        <div>${typeBadge}${senderHtml}</div>
                        <div class="${valClass}">${valStr}</div>
                        <div class="tx-id" onclick="copy('${log.tx_id}')" title="Copy">#${log.tx_id.substring(0, 8)}...</div>
                    </div>`;
            }).join('');
            document.getElementById('ledgerList').innerHTML = html;
        } catch(e) {}
    }
    function copy(t) { navigator.clipboard.writeText(t); alert("ID Disalin!"); }
    setInterval(fetchAllData, 3000); fetchAllData();
</script>

</body>
</html>
