<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LIVE PUBLIC LEDGER - NUSWANTARA</title>
    <style>
        body { 
            background-color: #050505; 
            color: #ccc; 
            font-family: 'Segoe UI', 'Courier New', monospace; 
            margin: 0; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh;
        }

        .container { 
            width: 100%; 
            max-width: 1000px; 
            border: 1px solid #222; 
            background: #090909; 
            border-radius: 15px; 
            overflow: hidden; 
            box-shadow: 0 0 80px rgba(0,0,0,0.8);
        }

        /* HEADER */
        .header {
            background: #111;
            padding: 20px 30px;
            border-bottom: 1px solid #222;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 { margin: 0; font-size: 1.2rem; color: #f1c40f; letter-spacing: 3px; text-transform: uppercase; font-weight: 800; }
        .sub-head { font-size: 0.75rem; color: #666; letter-spacing: 1px; }

        .live-indicator {
            display: flex; align-items: center; gap: 10px; font-size: 0.8rem;
            color: #2ecc71; font-weight: bold; background: rgba(46, 204, 113, 0.1);
            padding: 5px 12px; border-radius: 20px; border: 1px solid rgba(46, 204, 113, 0.3);
        }
        .status-dot { height: 8px; width: 8px; background-color: #2ecc71; border-radius: 50%; box-shadow: 0 0 10px #2ecc71; animation: blink 1.5s infinite; }
        @keyframes blink { 0% {opacity:1;} 50% {opacity:0.4;} 100% {opacity:1;} }

        /* DASHBOARD SUMMARY (YANG HILANG TADI) */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border-bottom: 2px solid #333;
        }
        .stat-card {
            padding: 20px;
            text-align: center;
            border-right: 1px solid #222;
            background: #0e0e0e;
        }
        .stat-card:last-child { border-right: none; }
        
        .stat-val { font-size: 2.5rem; font-weight: bold; margin: 5px 0; }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 2px; color: #666; }
        
        .gold-txt { color: #f1c40f; text-shadow: 0 0 20px rgba(241, 196, 15, 0.2); }
        .silver-txt { color: #bdc3c7; text-shadow: 0 0 20px rgba(189, 195, 199, 0.2); }

        /* LIST AREA */
        #ledgerList { height: 60vh; overflow-y: auto; }

        .tx-row {
            display: grid;
            grid-template-columns: 1.2fr 1.5fr 1.5fr 1fr; 
            padding: 15px 30px;
            border-bottom: 1px solid #1a1a1a;
            align-items: center;
            transition: 0.2s;
            font-size: 0.9rem;
        }
        .tx-row:hover { background: #151515; }
        
        .col-head { background: #0e0e0e; color: #555; font-size: 0.7rem; font-weight: bold; border-bottom: 1px solid #222; }

        /* BADGES & VALUES */
        .badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 0.65rem; text-transform: uppercase; width: fit-content; display: inline-block; }
        .type-mint { background: rgba(46, 204, 113, 0.15); color: #2ecc71; border: 1px solid #2ecc71; }
        .type-burn { background: rgba(231, 76, 60, 0.15); color: #e74c3c; border: 1px solid #e74c3c; }
        .type-transfer { background: rgba(52, 152, 219, 0.15); color: #3498db; border: 1px solid #3498db; }

        .val-plus { color: #2ecc71; font-weight: bold; }
        .val-min { color: #e74c3c; font-weight: bold; }
        .val-neutral { color: #3498db; font-weight: bold; }
        
        .tx-id { color: #444; font-size: 0.7rem; cursor: pointer; text-decoration: none; text-align: right; font-family: monospace; }
        .tx-id:hover { color: #888; text-decoration: underline; }
        .time-box { display: flex; flex-direction: column; }
        .time-main { color: #ccc; font-weight: bold; }
        .time-sub { color: #555; font-size: 0.75rem; }
        .sender-info { display: block; font-size: 0.65rem; color: #666; margin-top: 4px; font-style: italic; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #090909; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>
            <h1>PUBLIC LEDGER</h1>
            <div class="sub-head">BLOCKCHAIN TRANSPARENCY MONITOR</div>
        </div>
        <div class="live-indicator"><div class="status-dot"></div>SYSTEM LIVE</div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total Beredar Setara (Emas)</div>
            <div class="stat-val gold-txt" id="sumDinar">0.00 <span style="font-size:1rem;">Dn</span></div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Beredar Setara (Perak) </div>
            <div class="stat-val silver-txt" id="sumDirham">0.00 <span style="font-size:1rem;">Dr</span></div>
        </div>
    </div>

    <div class="tx-row col-head">
        <div>TIMESTAMP</div>
        <div>JENIS TRANSAKSI</div>
        <div>NOMINAL</div>
        <div style="text-align:right;">TX ID</div>
    </div>

    <div id="ledgerList">
        <div style="padding:50px; text-align:center; color:#333;">Memuat data blockchain...</div>
    </div>
</div>

<script>
    const DB_URL = "https://pasarnuswantara-default-rtdb.asia-southeast1.firebasedatabase.app/";
    const MG_PER_DINAR = 80460;
    const MG_PER_DIRHAM = 2980;

    async function fetchAllData() {
        let bust = "?r=" + Date.now();
        
        try {
            // 1. FETCH TOTAL SUPPLY (SUM)
            let resStats = await fetch(`${DB_URL}market_stats.json${bust}`);
            let stats = await resStats.json();
            let totalMg = (stats && stats.total_supply_mg) ? parseInt(stats.total_supply_mg) : 0;
            
            // Konversi ke Dinar/Dirham Display
            let dinar = (totalMg / MG_PER_DINAR).toFixed(2);
            let dirham = (totalMg / MG_PER_DIRHAM).toFixed(2);
            
            // Animasi angka (sedikit efek)
            document.getElementById('sumDinar').innerHTML = `${dinar} <span style="font-size:1rem;">Dn</span>`;
            document.getElementById('sumDirham').innerHTML = `${dirham} <span style="font-size:1rem;">Dr</span>`;

            // 2. FETCH TRANSAKSI (LIST)
            let resLedger = await fetch(`${DB_URL}public_ledger.json?orderBy="$key"&limitToLast=50`);
            let data = await resLedger.json();
            
            if(!data) {
                document.getElementById('ledgerList').innerHTML = '<div style="padding:50px; text-align:center; color:#444;">Belum ada catatan transaksi publik.</div>';
                return;
            }

            let logs = Object.values(data).sort((a,b) => b.timestamp - a.timestamp);
            
            let html = logs.map(log => {
                let dateObj = new Date(log.timestamp);
                let timeStr = dateObj.toLocaleTimeString('id-ID');
                let dateStr = dateObj.toLocaleDateString('id-ID');
                
                let isMint = log.type === 'MINT';
                let isBurn = log.type === 'BURN';
                let typeBadge, valClass, valStr, senderHtml = "";

                if (isMint) {
                    typeBadge = `<span class="badge type-mint">CETAK (MINT)</span>`; valClass = 'val-plus'; valStr = `+ ${log.label}`;
                    senderHtml = `<span class="sender-info">Issuer: BANK SENTRAL</span>`;
                } else if (isBurn) {
                    typeBadge = `<span class="badge type-burn">BAKAR (BURN)</span>`; valClass = 'val-min'; 
                    valStr = log.label; if(!valStr.includes("-")) valStr = "- " + valStr;
                    senderHtml = `<span class="sender-info">To: BANK SENTRAL</span>`;
                } else {
                    typeBadge = `<span class="badge type-transfer">TRANSFER (P2P)</span>`; valClass = 'val-neutral'; valStr = `> ${log.label}`;
                    let sender = log.sender || "ANONIM"; senderHtml = `<span class="sender-info">From: ${sender}</span>`;
                }

                return `
                    <div class="tx-row">
                        <div class="time-box"><span class="time-main">${timeStr}</span><span class="time-sub">${dateStr}</span></div>
                        <div>${typeBadge}${senderHtml}</div>
                        <div class="${valClass}">${valStr}</div>
                        <div class="tx-id" onclick="copy('${log.tx_id}')" title="Salin ID">#${log.tx_id.substring(0, 8)}...</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('ledgerList').innerHTML = html;

        } catch(e) { console.error("Error fetching data:", e); }
    }

    function copy(text) { navigator.clipboard.writeText(text); alert("ID Disalin: " + text); }

    // Refresh 3 Detik
    setInterval(fetchAllData, 3000);
    fetchAllData(); 
</script>

</body>
</html>
