<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuswantara Public Ledger v4.9</title>
    <style>
        :root { --neon: #d4af37; --bg: #050505; --card: #111; --border: #333; }
        body { background-color: var(--bg); color: #e0e0e0; font-family: 'Segoe UI', monospace; margin: 0; padding: 20px; }
        .container { max-width: 950px; margin: 0 auto; border: 1px solid var(--border); border-radius: 15px; padding: 20px; box-shadow: 0 0 60px rgba(0,0,0,0.8); background: #0b0b0b; }
        
        /* HEADER WAKTU (OFFSET CALIBRATED) */
        .time-header { text-align: center; border-bottom: 2px solid var(--neon); padding-bottom: 15px; margin-bottom: 20px; background: rgba(20,20,20,0.6); border-radius: 10px; padding-top: 15px; border: 1px solid #222; }
        .nusa-year { font-size: 0.8rem; color: #777; letter-spacing: 4px; text-transform: uppercase; margin-bottom: 5px; }
        .nusa-date { font-size: 1.8rem; color: var(--neon); font-weight: bold; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; text-shadow: 0 0 15px rgba(212, 175, 55, 0.4); }
        .nusa-time-block { display: flex; justify-content: center; align-items: baseline; gap: 10px; margin-top: 5px; }
        .nusa-phase { font-size: 1.5rem; color: #fff; font-weight: bold; letter-spacing: 2px; }
        .nusa-digital { font-size: 1.2rem; color: #f39c12; font-family: 'Courier New', monospace; background: #000; padding: 2px 8px; border-radius: 4px; border: 1px solid #444; }
        .nusa-desc { font-size: 0.75rem; color: #aaa; font-style: italic; margin-top: 5px; }

        /* LIVE STATUS */
        .sub-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 5px; }
        h1 { color: #f39c12; margin: 0; font-size: 1.1rem; letter-spacing: 2px; text-transform: uppercase; }
        .live-status { display: inline-flex; align-items: center; background: rgba(46, 204, 113, 0.1); border: 1px solid rgba(46, 204, 113, 0.3); padding: 5px 12px; border-radius: 20px; }
        .blink-dot { width: 6px; height: 6px; background-color: #2ecc71; border-radius: 50%; display: inline-block; margin-right: 8px; box-shadow: 0 0 8px #2ecc71; animation: pulse 1.5s infinite; }
        .status-text { font-size: 0.65rem; color: #2ecc71; font-weight: bold; letter-spacing: 1px; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* DASHBOARD */
        .dashboard { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px; }
        .card { background: #141414; border: 1px solid #222; padding: 15px; text-align: center; border-radius: 10px; }
        .card-title { color: #888; font-size: 0.6rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .card-val { font-size: 1.6rem; font-weight: bold; color: #fff; }
        .gold { color: #f1c40f; text-shadow: 0 0 10px rgba(241, 196, 15, 0.2); }
        .silver { color: #bdc3c7; text-shadow: 0 0 10px rgba(189, 195, 199, 0.2); }
        .card-note { font-size: 0.55rem; color: #444; margin-top: 5px; font-style: italic; }

        /* DAILY STATS */
        .daily-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 25px; }
        .mini-card { background: #141414; border: 1px solid #222; padding: 10px; text-align: center; border-radius: 8px; }
        .mini-label { font-size: 0.55rem; color: #555; text-transform: uppercase; letter-spacing: 0.5px; }
        .mini-val { font-size: 1rem; font-weight: bold; margin-top: 2px; font-family: monospace; }
        .limit-over { color: #e74c3c; animation: pulse 0.5s infinite; } .limit-warn { color: #f1c40f; } .limit-ok { color: #2ecc71; }

        /* TABEL LOG */
        .ledger-box { border: 1px solid #222; height: 500px; overflow-y: auto; background: #000; padding: 0; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        th { text-align: left; background: #1a1a1a; padding: 12px 15px; color: #888; text-transform: uppercase; font-size: 0.6rem; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid #333; letter-spacing: 1px; }
        td { border-bottom: 1px solid #111; padding: 10px 15px; vertical-align: top; }
        tr:hover { background: #0e0e0e; }

        /* BADGES & FLOW */
        .badge { padding: 3px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: bold; border: 1px solid transparent; display: inline-block; text-transform: uppercase; width: 70px; text-align: center; margin-bottom: 4px; }
        .bg-mint { background: rgba(46, 204, 113, 0.1); color: #2ecc71; border-color: #2ecc71; }
        .bg-trf { background: rgba(52, 152, 219, 0.1); color: #3498db; border-color: #3498db; }
        .bg-burn { background: rgba(231, 76, 60, 0.1); color: #e74c3c; border-color: #e74c3c; }
        
        .tx-val { font-weight: bold; font-size: 0.85rem; font-family: monospace; }
        .tx-ref { font-family: monospace; font-size: 0.55rem; color: #555; display: block; letter-spacing: 0.5px; }
        
        .flow-container { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; }
        .id-badge { background: #222; color: #ddd; padding: 2px 6px; border-radius: 4px; border: 1px solid #444; font-family: monospace; font-size: 0.7rem; }
        .sys-badge { background: rgba(243, 156, 18, 0.15); color: #f39c12; padding: 2px 6px; border-radius: 4px; border: 1px solid #f39c12; font-weight: bold; font-size: 0.65rem; letter-spacing: 1px; }
        .arrow { color: #666; font-size: 0.8rem; }

        .refresh-btn { background: #1a1a1a; color: var(--neon); border: 1px solid #333; padding: 12px; width: 100%; border-radius: 8px; cursor: pointer; margin-top: 20px; transition: 0.3s; font-weight: bold; letter-spacing: 2px; text-transform: uppercase; }
        .refresh-btn:hover { background: #222; border-color: var(--neon); }
    </style>
</head>
<body>

<div class="container">
    
    <div class="time-header">
        <div id="nusaYear" class="nusa-year">TAHUN ...</div>
        <div id="nusaFullDate" class="nusa-date">...</div>
        <div class="nusa-time-block">
            <div id="nusaPhase" class="nusa-phase">...</div>
            <div id="nusaClock" class="nusa-digital">00:00</div>
        </div>
        <div id="nusaDesc" class="nusa-desc">...</div>
    </div>

    <div class="sub-header">
        <h1>NERACA & LEDGER</h1>
        <div class="live-status">
            <span class="blink-dot"></span>
            <span class="status-text">LIVE SYNC</span>
        </div>
    </div>
    
    <div class="dashboard">
        <div class="card">
            <div class="card-title">Suplai Beredar (Emas)</div>
            <div id="circDinar" class="card-val gold">0.00 Dn</div>
            <div id="eqGold" style="font-size:0.65rem; color:#666; margin-top:5px;">... Gram Au</div>
            <div class="card-note">Total Cetak - Total Hangus</div>
        </div>
        <div class="card">
            <div class="card-title">Suplai Beredar (Perak)</div>
            <div id="circDirham" class="card-val silver">0.00 Dr</div>
            <div id="eqSilver" style="font-size:0.65rem; color:#666; margin-top:5px;">... Gram Ag</div>
            <div class="card-note">Total Cetak - Total Hangus</div>
        </div>
    </div>

    <div class="daily-stats">
        <div class="mini-card">
            <div class="mini-label">QUOTA HARIAN</div>
            <div id="dailyTotalDisplay" class="mini-val limit-ok">0 / 1000</div>
        </div>
        <div class="mini-card" style="border-bottom: 2px solid #3498db;">
            <div class="mini-label" style="color:#3498db;">TRANSFER</div>
            <div id="dailyTrfCount" class="mini-val" style="color:#fff;">0</div>
        </div>
        <div class="mini-card" style="border-bottom: 2px solid #2ecc71;">
            <div class="mini-label" style="color:#2ecc71;">CETAK</div>
            <div id="dailyMintCount" class="mini-val" style="color:#fff;">0</div>
        </div>
    </div>

    <div class="ledger-box">
        <table id="ledgerTable">
            <thead>
                <tr>
                    <th width="30%">Waktu (Nusa)</th>
                    <th width="15%">Ref ID</th>
                    <th width="35%">Arus Dana</th>
                    <th width="20%" style="text-align:right;">Nominal</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr><td colspan="4" style="text-align:center; padding:50px; color:#555;">
                    ðŸ“¡ Mengambil Data Neraca...
                </td></tr>
            </tbody>
        </table>
    </div>

    <button onclick="loadLedger()" class="refresh-btn">Segarkan Data</button>
</div>

<script>
    const DB_URL = "https://pasarnuswantara-default-rtdb.asia-southeast1.firebasedatabase.app/";
    const MG_PER_DIRHAM = 2980;
    const MG_PER_DINAR = 80460;
    const DAILY_LIMIT = 1000;
    
    // --- SETTING MANUAL OFFSET TANGGAL (PENTING!) ---
    // Ganti angka ini jika tanggal masih meleset.
    // 1 = Tambah 1 hari dari tanggal komputer.
    // 0 = Sama dengan tanggal komputer.
    const DATE_OFFSET = 1; 

    const NUSA_MONTH_MAP = ["Wiwitan", "Gangga", "Bija", "Trubus", "Teja", "Baskara", "Kartika", "Huma", "Phala", "Reswara", "Purnaka", "LUMBUNG"]; 
    const PASARANS = ["Legi", "Pahing", "Pon", "Wage", "Kliwon"];
    const YEAR_CONFIG = {
        "2025": { code: "001", label: "TAHUN 001 - AIR (VENUS)" },
        "2026": { code: "002", label: "TAHUN 002 - BATU (SATURNUS)" }
    };
    const PHASE_DB = [
        { id: 7, name: "ISTIWA", desc: "Hening/Istiwa", range: [12, 14] },
        { id: 8, name: "ASAR", desc: "Wrapping Up", range: [15, 17] },
        { id: 1, name: "SANDIKALA", desc: "Transisi & Sosial", range: [18, 20] },
        { id: 2, name: "SIREPAN", desc: "Istirahat Fisik", range: [21, 23] },
        { id: 3, name: "HENING", desc: "Istirahat Mental", range: [0, 2] },
        { id: 4, name: "FAJAR", desc: "The Golden Hour", range: [3, 5] },
        { id: 5, name: "DUHA", desc: "Start Engine", range: [6, 8] },
        { id: 6, name: "KARYA", desc: "High Performance", range: [9, 11] }
    ];

    // --- KALKULASI JAM NUSWANTARA (90 Menit = 1 Jam Nusa) ---
    function convertToNusaClock(h, m) {
        let mTotal = ((h % 12) * 60) + m;
        let nTotalHours = mTotal / 90; 
        let nHour = Math.floor(nTotalHours);
        let nMin = Math.floor((nTotalHours % 1) * 90); 
        
        if (nHour === 0) nHour = 8; // Jam 0 (12:00/00:00) = Jam 8
        return `${String(nHour).padStart(2,'0')}:${String(nMin).padStart(2,'0')}`;
    }

    // --- FUNGSI WAKTU & TANGGAL (WITH OFFSET) ---
    function getNusaCalendar(timestamp) {
        // Buat object date
        let dateObj = new Date(timestamp);
        
        // --- APPLY OFFSET DISINI ---
        // Menambah hari sesuai konfigurasi DATE_OFFSET
        dateObj.setDate(dateObj.getDate() + DATE_OFFSET);

        let year = dateObj.getFullYear();
        let monthIdx = dateObj.getMonth();
        let dateNum = dateObj.getDate(); 

        let config = YEAR_CONFIG[year] || { code: "XXX", label: `TAHUN M-${year}` };
        let monthName = NUSA_MONTH_MAP[monthIdx] || "SUWUNG";

        // Pasaran (Hitung berdasarkan tanggal yang SUDAH di-offset)
        let anchor2025 = new Date(2025, 2, 21);
        let diffTotal = Math.floor((dateObj - anchor2025) / 86400000);
        let pIdx = (2 + (diffTotal % 5)) % 5; 
        if(pIdx < 0) pIdx += 5;

        return {
            yearCode: config.code,
            yearLabel: config.label,
            date: dateNum, 
            month: monthName.toUpperCase(),
            pasaran: PASARANS[pIdx].toUpperCase(),
            fullString: `${dateNum} ${monthName.toUpperCase()} ${config.code}`
        };
    }

    function getNusaTime(timestamp) {
        let d = new Date(timestamp);
        let h = d.getHours();
        let m = d.getMinutes();
        
        let seqIdx = Math.floor(h / 3); 
        const phaseMap = [3, 4, 5, 6, 7, 8, 1, 2];
        let pId = phaseMap[seqIdx];
        let p = PHASE_DB.find(x => x.id === pId);
        let period = (h >= 6 && h < 18) ? "SIANG" : "MALAM";

        let digitalNusa = convertToNusaClock(h, m);

        return {
            name: p.name,
            desc: p.desc,
            clock: digitalNusa,
            period: period
        };
    }

    function updateHeader() {
        const now = Date.now();
        const cal = getNusaCalendar(now);
        const time = getNusaTime(now);
        document.getElementById('nusaYear').innerText = cal.yearLabel;
        document.getElementById('nusaFullDate').innerText = cal.fullString;
        document.getElementById('nusaPhase').innerText = time.name;
        document.getElementById('nusaClock').innerText = `${time.clock} ${time.period}`;
        document.getElementById('nusaDesc').innerText = time.desc;
    }
    setInterval(updateHeader, 1000);
    updateHeader();

    // --- HELPER FLOW ---
    function formatFlowID(id) {
        if(!id || id === "SYS" || id === "SYSTEM" || id === "BANK") {
            return `<span class="sys-badge">SYSTEM</span>`;
        }
        let clean = id.replace("WARGA-", "");
        return `<span class="id-badge">${clean}</span>`;
    }

    async function loadLedger() {
        const tbody = document.getElementById('tableBody');
        try {
            let res = await fetch(`${DB_URL}public_ledger.json`);
            let data = await res.json();
            
            let txs = [];
            if(data) {
                for(let k in data) {
                    data[k].txId = k; 
                    txs.push(data[k]);
                }
                txs.sort((a,b) => (b.timestamp || b.time) - (a.timestamp || a.time));
            }

            let html = "";
            let supplyMg = 0;
            let today = new Date(); today.setHours(0,0,0,0);
            let startOfDay = today.getTime();
            let dCount=0, dTrf=0, dMint=0;

            txs.forEach(tx => {
                let mg = parseInt(tx.val) || 0;
                let t = tx.timestamp || tx.time || 0;
                let rawId = tx.tx_id || tx.txId || "UNK";
                let shortId = rawId.substring(0,8)+"...";

                let rawFrom = tx.from || tx.issuer || "SYSTEM";
                let rawTo = tx.to || "SYSTEM";

                let badgeClass="bg-trf", badgeLabel="TRANSFER";
                if (tx.type === 'MINT' || tx.type === 'ISSUED') {
                    badgeClass="bg-mint"; badgeLabel="CETAK"; supplyMg += mg;
                    rawFrom = "SYSTEM";
                } else if (tx.type === 'CASH_OUT' || tx.type === 'BURN') {
                    badgeClass="bg-burn"; badgeLabel="HANGUS"; supplyMg -= mg;
                    rawTo = "SYSTEM";
                } else {
                    badgeClass="bg-trf"; badgeLabel="KIRIM";
                }

                if(t >= startOfDay) {
                    dCount++;
                    if(tx.type === 'MINT' || tx.type === 'ISSUED') dMint++;
                    else if(tx.type === 'P2P' || tx.type === 'TRANSFER' || !tx.type) dTrf++;
                }

                let cal = getNusaCalendar(t);
                let tim = getNusaTime(t);
                
                let detailTime = `<span style="color:#b8860b; font-weight:bold; font-size:0.9rem;">${cal.date} ${cal.month}</span> <br> <span style="color:#fff; font-weight:bold;">${tim.name}</span> <span style="color:#777; font-family:monospace;">${tim.clock}</span>`;

                let flowHtml = `
                    <div class="flow-container">
                        ${formatFlowID(rawFrom)} 
                        <span class="arrow">âž”</span> 
                        ${formatFlowID(rawTo)}
                    </div>
                `;

                let valStr = (mg >= 80460) ? (mg/80460).toFixed(2)+" Dn" : (mg/2980).toFixed(2)+" Dr";
                let colorVal = (mg >= 80460) ? "#f1c40f" : "#bdc3c7";

                html += `
                <tr>
                    <td>${detailTime}</td>
                    <td style="vertical-align:middle;">
                        <span class="badge ${badgeClass}">${badgeLabel}</span>
                        <span class="tx-ref">#${shortId}</span>
                    </td>
                    <td>${flowHtml}</td>
                    <td style="text-align:right;"><span class="tx-val" style="color:${colorVal}">${valStr}</span></td>
                </tr>`;
            });

            if(txs.length === 0) html = '<tr><td colspan="4" style="text-align:center; padding:30px; color:#555;">Data Ledger Kosong</td></tr>';
            tbody.innerHTML = html;

            if(supplyMg < 0) supplyMg = 0; 
            let tD = supplyMg / MG_PER_DINAR;
            let tDr = supplyMg / MG_PER_DIRHAM;
            
            document.getElementById('circDinar').innerText = tD.toFixed(2) + " Dn";
            document.getElementById('circDirham').innerText = tDr.toFixed(2) + " Dr";
            document.getElementById('eqGold').innerText = `Eq: ${(tD * 4.25).toFixed(2)}g Au`;
            document.getElementById('eqSilver').innerText = `Eq: ${(tDr * 2.975).toFixed(2)}g Ag`;

            let dlEl = document.getElementById('dailyTotalDisplay');
            dlEl.innerText = `${dCount} / ${DAILY_LIMIT}`;
            dlEl.className = "mini-val " + (dCount >= DAILY_LIMIT ? "limit-over" : (dCount >= DAILY_LIMIT*0.8 ? "limit-warn" : "limit-ok"));
            document.getElementById('dailyTrfCount').innerText = dTrf;
            document.getElementById('dailyMintCount').innerText = dMint;

        } catch(e) { tbody.innerHTML = `<tr><td colspan="4" style="color:#e74c3c; text-align:center;">Error: ${e}</td></tr>`; }
    }

    loadLedger();
    setInterval(loadLedger, 30000);
</script>

</body>
</html>
